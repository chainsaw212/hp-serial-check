<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="HP Serial">
<meta name="theme-color" content="#0096D6">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<title>HP ì‹œë¦¬ì–¼ ìƒì‚°ì¼ì ì¡°íšŒ</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
    background: #f4f4f4;
    color: #2d2d2d;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* ìƒë‹¨ í—¤ë” ë°” */
  .top-bar {
    width: 100%;
    background: #0096D6;
    padding: 14px 20px;
    padding-top: calc(env(safe-area-inset-top, 14px) + 6px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .top-bar .logo {
    width: 32px;
    height: 32px;
    background: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 14px;
    color: #0096D6;
    flex-shrink: 0;
  }
  .top-bar .title {
    font-size: 17px;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.3px;
  }

  /* ë©”ì¸ ì»¨í…ì¸  */
  .content {
    width: 100%;
    max-width: 540px;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .page-title {
    font-size: 22px;
    font-weight: 700;
    color: #1a1a2e;
    text-align: center;
    margin-bottom: 2px;
  }
  .page-subtitle {
    font-size: 14px;
    color: #6b7280;
    text-align: center;
    margin-bottom: 4px;
  }

  /* ì…ë ¥ ì˜ì—­ ì¹´ë“œ */
  .input-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .camera-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: #0096D6;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    padding: 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }
  .camera-btn:active { background: #007ab8; transform: scale(0.98); }
  .camera-btn .icon { font-size: 20px; }

  .gallery-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: #fff;
    color: #0096D6;
    font-size: 16px;
    font-weight: 600;
    padding: 15px;
    border: 2px solid #0096D6;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }
  .gallery-btn:active { background: #e8f6fc; transform: scale(0.98); }
  .gallery-btn .icon { font-size: 20px; }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #b0b0b0;
    font-size: 12px;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e5e7eb;
  }

  .manual-row {
    display: flex;
    gap: 8px;
  }
  .manual-input {
    flex: 1;
    background: #f9fafb;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 16px;
    color: #1a1a2e;
    outline: none;
    font-family: 'SF Mono', 'Menlo', 'Courier New', monospace;
    letter-spacing: 1px;
  }
  .manual-input::placeholder { color: #9ca3af; }
  .manual-input:focus { border-color: #0096D6; box-shadow: 0 0 0 3px rgba(0,150,214,0.12); }

  .check-btn {
    background: #0096D6;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
  }
  .check-btn:active { background: #007ab8; }

  /* OCR ìƒíƒœ */
  .ocr-status {
    text-align: center;
    font-size: 13px;
    color: #6b7280;
    min-height: 20px;
  }

  /* ë‚ ì§œì½”ë“œ 3ìë¦¬ ì…ë ¥ ì˜ì—­ */
  .datecode-section {
    display: none;
    flex-direction: column;
    gap: 8px;
    animation: fadeIn 0.2s ease;
  }
  .datecode-section.active { display: flex; }

  .datecode-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: none;
    border: 1.5px dashed #0096D6;
    border-radius: 8px;
    padding: 10px;
    color: #0096D6;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .datecode-toggle:active { background: #e8f6fc; }
  .datecode-toggle.open {
    border-style: solid;
    background: #e8f6fc;
  }

  .datecode-row {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .datecode-label {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    min-width: 28px;
    text-align: center;
  }
  .datecode-input {
    width: 38px;
    height: 38px;
    background: #fff;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    font-family: 'SF Mono', 'Menlo', 'Courier New', monospace;
    color: #1a1a2e;
    outline: none;
    text-transform: uppercase;
  }
  .datecode-input:focus {
    border-color: #0096D6;
    box-shadow: 0 0 0 3px rgba(0,150,214,0.12);
  }
  .datecode-input::placeholder {
    color: #d1d5db;
    font-weight: 400;
    font-size: 14px;
  }
  .datecode-hint {
    font-size: 11px;
    color: #9ca3af;
    text-align: center;
    margin-top: -2px;
  }

  /* 3ê°€ì§€ í˜•ì‹ë³„ ë‚ ì§œì½”ë“œ ì…ë ¥ ì¹´ë“œ */
  .dc-row-card {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
  }
  .dc-row-left {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 3px;
    min-width: 110px;
  }
  .dc-format-badge {
    display: inline-block;
    background: #0096D6;
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    letter-spacing: 0.3px;
  }
  .dc-format-badge.badge-25 { background: #7c3aed; }
  .dc-format-badge.badge-14 { background: #059669; }
  .dc-serial-diagram {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 11px;
    color: #6b7280;
    white-space: nowrap;
    margin-top: 2px;
  }
  .dc-serial-diagram .dc-hl {
    color: #0096D6;
    font-weight: 700;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .dc-pos-text {
    font-size: 10px;
    color: #9ca3af;
    font-weight: 500;
  }
  .dc-row-right {
    flex: 1;
    display: flex;
    justify-content: flex-end;
  }
  .dc-inputs-group {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .dc-go-btn {
    width: 36px;
    height: 38px;
    background: #0096D6;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.15s;
    flex-shrink: 0;
  }
  .dc-go-btn:active { background: #007ab8; }

  .datecode-check-btn {
    flex: 1;
    background: #0096D6;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    padding: 10px 0;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .datecode-check-btn:active { background: #007ab8; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ê²°ê³¼ ì¹´ë“œ */
  .result-card {
    width: 100%;
    max-width: 540px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    overflow: hidden;
    display: none;
    margin: 0 16px;
  }
  .result-card.show { display: block; }

  .result-header {
    background: #0096D6;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .result-header .badge {
    font-size: 11px;
    font-weight: 700;
    background: rgba(255,255,255,0.25);
    color: #fff;
    padding: 3px 10px;
    border-radius: 20px;
  }
  .result-header .serial-text {
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    color: rgba(255,255,255,0.9);
    letter-spacing: 0.8px;
    word-break: break-all;
  }

  /* OCR ì¸ì‹ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
  .ocr-preview-section {
    padding: 10px 16px 6px;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
  }

  /* ë°”ì½”ë“œ/OCR ì¸ì‹ ì¶œì²˜ í‘œì‹œ */
  .recognition-source {
    padding: 10px 18px;
    background: #f0fdf4;
    border-bottom: 1px solid #bbf7d0;
    font-size: 12px;
    line-height: 1.6;
  }
  .recognition-source .source-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 2px;
  }
  .recognition-source .source-row:last-child { margin-bottom: 0; }
  .recognition-source .source-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .source-badge.barcode {
    background: #16a34a;
    color: #fff;
  }
  .source-badge.ocr {
    background: #d1d5db;
    color: #6b7280;
  }
  .recognition-source .source-serial {
    font-family: 'SF Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.3px;
    color: #374151;
  }
  .recognition-source .source-serial.active {
    font-weight: 700;
    color: #15803d;
  }
  .recognition-source .source-serial.muted {
    color: #9ca3af;
    text-decoration: line-through;
  }
  .recognition-source .source-label {
    font-size: 10px;
    color: #9ca3af;
    margin-left: auto;
    flex-shrink: 0;
  }
  .ocr-preview-label {
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 6px;
  }
  .ocr-preview-wrap {
    border-radius: 8px;
    overflow: hidden;
    border: 1.5px solid #d1d5db;
    background: #fff;
    position: relative;
  }
  .ocr-preview-img {
    width: 100%;
    display: block;
    object-fit: contain;
    background: #f1f5f9;
    cursor: pointer;
    transition: max-height 0.3s ease;
  }
  .ocr-preview-img.zoomed {
    transform: scale(1.3);
    transform-origin: center;
  }
  .ocr-preview-hint {
    font-size: 10px;
    color: #9ca3af;
    text-align: center;
    margin-top: 4px;
    line-height: 1.4;
  }
  .ocr-preview-hint .ymd-mark {
    display: inline-block;
    width: 18px;
    height: 3px;
    background: rgba(220, 38, 38, 0.7);
    border-radius: 2px;
    vertical-align: middle;
    margin: 0 2px;
  }

  /* í° ë‚ ì§œ */
  .date-display {
    padding: 28px 18px;
    text-align: center;
    background: #f0fdf4;
  }
  .date-display .label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: 600;
  }
  .date-display .date {
    font-size: 46px;
    font-weight: 800;
    color: #059669;
    letter-spacing: 2px;
    line-height: 1.2;
  }
  .date-display .date-sub {
    font-size: 15px;
    color: #10b981;
    margin-top: 6px;
    font-weight: 500;
  }

  /* íŒŒì‹± ê·¼ê±° */
  .detail-section {
    padding: 16px 18px;
    border-top: 1px solid #f0f0f0;
  }
  .detail-title {
    font-size: 12px;
    color: #9ca3af;
    margin-bottom: 10px;
    letter-spacing: 1px;
    font-weight: 600;
  }
  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px solid #f5f5f5;
  }
  .detail-row:last-child { border-bottom: none; }
  .detail-row .key {
    font-size: 13px;
    color: #6b7280;
  }
  .detail-row .val {
    font-size: 13px;
    font-family: 'SF Mono', monospace;
    color: #1a1a2e;
  }
  .detail-row .highlight {
    color: #0096D6;
    font-weight: 700;
  }

  /* ì—ëŸ¬ */
  .error-msg {
    text-align: center;
    color: #dc2626;
    font-size: 14px;
    padding: 24px 18px;
    background: #fef2f2;
  }

  /* íˆìŠ¤í† ë¦¬ */
  .history-section {
    width: 100%;
    max-width: 540px;
    padding: 0 16px;
    margin-top: 4px;
  }
  .history-title {
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 8px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    border-radius: 10px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: background 0.15s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .history-item:active { background: #f0f9ff; }
  .history-item .h-serial {
    font-family: 'SF Mono', monospace;
    font-size: 12px;
    color: #6b7280;
    letter-spacing: 0.5px;
  }
  .history-item .h-date {
    font-size: 14px;
    font-weight: 700;
    color: #059669;
  }

  /* ìˆ¨ê¸´ file input */
  #cameraInput, #galleryInput { display: none; }

  /* canvas for OCR */
  #ocrCanvas { display: none; }

  /* ====== ì¹´ë©”ë¼ ê°€ì´ë“œë¼ì¸ ì˜¤ë²„ë ˆì´ ====== */
  .camera-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9999;
    background: #000;
    display: none;
    flex-direction: column;
  }
  .camera-overlay.active { display: flex; }

  .camera-overlay video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .camera-guide-layer {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
  }

  /* ê°€ì´ë“œ ë°•ìŠ¤ ìœ„ì•„ë˜ ì–´ë‘ìš´ ì˜ì—­ */
  .guide-mask-top, .guide-mask-bottom {
    position: absolute;
    left: 0; right: 0;
    background: rgba(0,0,0,0.55);
  }
  .guide-mask-top { top: 0; }
  .guide-mask-bottom { bottom: 0; }
  .guide-mask-left, .guide-mask-right {
    position: absolute;
    background: rgba(0,0,0,0.55);
  }

  /* ê°€ì´ë“œ ë°•ìŠ¤ â€” ê°€ë¡œë¡œ ê¸´ ì§ì‚¬ê°í˜• (ì‹œë¦¬ì–¼ ë²ˆí˜¸ ë§ì¶¤) */
  .guide-box {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border: 2.5px solid #0096D6;
    border-radius: 10px;
    box-shadow: 0 0 0 4000px rgba(0,0,0,0.55);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ê°€ì´ë“œ ë°•ìŠ¤ ì¤‘ì•™ì„  (ìˆ˜í‰ ì •ë ¬ ë„ìš°ë¯¸) */
  .guide-box .guide-centerline {
    position: absolute;
    left: 8px; right: 8px;
    top: 50%;
    height: 1px;
    background: rgba(0,150,214,0.35);
    pointer-events: none;
  }

  /* ê°€ì´ë“œ ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ íŒíŠ¸ */
  .guide-box .guide-inner-text {
    color: rgba(255,255,255,0.45);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 4px;
    text-align: center;
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
  }

  /* ê°€ì´ë“œ ë°•ìŠ¤ ì½”ë„ˆ ì¥ì‹ â€” ë” ê¸¸ê²Œ */
  .guide-box::before, .guide-box::after {
    content: '';
    position: absolute;
    width: 28px;
    height: 20px;
    border: 3px solid #fff;
  }
  .guide-box::before {
    top: -2px; left: -2px;
    border-right: none; border-bottom: none;
    border-radius: 8px 0 0 0;
  }
  .guide-box::after {
    top: -2px; right: -2px;
    border-left: none; border-bottom: none;
    border-radius: 0 8px 0 0;
  }

  .guide-corner-bl, .guide-corner-br {
    position: absolute;
    width: 28px;
    height: 20px;
    border: 3px solid #fff;
  }
  .guide-corner-bl {
    bottom: -2px; left: -2px;
    border-right: none; border-top: none;
    border-radius: 0 0 0 8px;
  }
  .guide-corner-br {
    bottom: -2px; right: -2px;
    border-left: none; border-top: none;
    border-radius: 0 0 8px 0;
  }

  /* ê°€ì´ë“œ í…ìŠ¤íŠ¸ */
  .guide-text-top {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(50% + 45px);
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    text-align: center;
    text-shadow: 0 1px 6px rgba(0,0,0,0.7);
    white-space: nowrap;
  }
  .guide-text-hint {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: calc(50% + 45px);
    color: rgba(255,255,255,0.7);
    font-size: 12px;
    text-align: center;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    white-space: nowrap;
  }

  /* ì´¬ì˜ ë²„íŠ¼ ì˜ì—­ */
  .camera-controls {
    position: absolute;
    bottom: 0;
    left: 0; right: 0;
    padding: 20px;
    padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 16px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    pointer-events: auto;
  }

  .shutter-btn {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: #fff;
    border: 4px solid rgba(255,255,255,0.4);
    cursor: pointer;
    position: relative;
    transition: transform 0.1s;
    pointer-events: auto;
  }
  .shutter-btn:active {
    transform: scale(0.92);
    background: #ddd;
  }
  .shutter-btn::after {
    content: '';
    position: absolute;
    top: 4px; left: 4px; right: 4px; bottom: 4px;
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.1);
  }

  .close-camera-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: #fff;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    pointer-events: auto;
  }
  .close-camera-btn:active { background: rgba(255,255,255,0.35); }

  /* í”Œë˜ì‹œ íš¨ê³¼ */
  .flash-effect {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #fff;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.1s;
  }
  .flash-effect.flash { opacity: 0.8; }

  /* í•˜ë‹¨ ì—¬ë°± */
  .bottom-spacer { height: 40px; }

  /* ====== ì°¸ì¡°í‘œ ë³´ê¸° ë²„íŠ¼ & íŒ¨ë„ ====== */
  .ref-toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    max-width: 540px;
    margin: 0 auto;
    padding: 12px 16px;
    background: #fff;
    border: 1.5px solid #d1d5db;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .ref-toggle-btn:active { background: #f0f9ff; border-color: #0096D6; color: #0096D6; }
  .ref-toggle-btn .arrow {
    transition: transform 0.2s;
    font-size: 12px;
  }
  .ref-toggle-btn.open .arrow { transform: rotate(180deg); }
  .ref-toggle-btn.open { border-color: #0096D6; color: #0096D6; background: #f0f9ff; }

  .ref-panel {
    width: 100%;
    max-width: 540px;
    margin: 0 auto;
    background: #fff;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
    padding: 0 16px;
  }
  .ref-panel.open {
    max-height: 2400px;
    opacity: 1;
    padding: 16px;
  }

  .ref-section-header {
    font-size: 13px;
    font-weight: 700;
    color: #0096D6;
    margin-bottom: 4px;
    padding: 6px 0 2px;
  }
  .ref-section-pos {
    font-size: 12px;
    color: #374151;
    margin-bottom: 10px;
    line-height: 1.5;
    font-family: 'SF Mono', monospace;
  }
  .ref-section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #d1d5db 30%, #d1d5db 70%, transparent);
    margin: 16px 0 14px;
  }

  /* í•˜ë‹¨ í‘¸í„° */
  .footer {
    width: 100%;
    text-align: center;
    padding: 16px 0 24px;
    font-size: 11px;
    color: #b0b0b0;
    letter-spacing: 0.5px;
  }
  .footer span {
    color: #9ca3af;
    font-weight: 600;
  }

  /* ====== ì• ë§¤í•œ ë¬¸ì ì„ íƒ UI ====== */
  .char-picker-section {
    padding: 16px 18px;
    border-top: 1px solid #f0f0f0;
    background: #fffbeb;
  }
  .char-picker-title {
    font-size: 12px;
    color: #b45309;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .char-picker-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .char-picker-row:last-child { border-bottom: none; }
  .char-picker-label {
    font-size: 13px;
    color: #6b7280;
    flex-shrink: 0;
    width: 70px;
  }
  .char-picker-options {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
  }
  .char-option {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 52px;
    height: 34px;
    padding: 0 8px;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .char-option:active { transform: scale(0.95); }
  .char-option.selected {
    background: #0096D6;
    color: #fff;
    border-color: #0096D6;
    box-shadow: 0 2px 6px rgba(0,150,214,0.3);
  }
  .char-option.ocr-original {
    border-color: #0096D6;
    color: #0096D6;
  }
  .char-option.ocr-original.selected {
    background: #0096D6;
    color: #fff;
  }
  .char-option .char-code {
    font-weight: 800;
    margin-right: 3px;
  }
  .char-option .char-decoded {
    font-size: 11px;
    opacity: 0.8;
    font-weight: 400;
  }

  /* ====== ì½”ë“œ ì°¸ì¡°í‘œ ====== */
  .ref-table-section {
    padding: 14px 18px;
    border-top: 1px solid #f0f0f0;
    background: #f9fafb;
  }
  .ref-table-title {
    font-size: 11px;
    color: #9ca3af;
    margin-bottom: 8px;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  .ref-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
    line-height: 1.4;
  }
  .ref-table th {
    background: #e5e7eb;
    color: #6b7280;
    font-weight: 600;
    padding: 4px 3px;
    text-align: center;
    border: 1px solid #d1d5db;
    white-space: nowrap;
  }
  .ref-table td {
    padding: 4px 3px;
    text-align: center;
    border: 1px solid #e5e7eb;
    font-family: 'SF Mono', monospace;
    color: #374151;
    white-space: nowrap;
  }
  .ref-table .code-highlight {
    font-weight: 800;
    color: #0096D6;
  }
  .ref-table tr.current-highlight td {
    background: #e0f2fe;
  }
</style>
</head>
<body>

<div class="top-bar">
  <div class="logo">hp</div>
  <span class="title">ì‹œë¦¬ì–¼ ìƒì‚°ì¼ì ì¡°íšŒ</span>
</div>

<div class="content">
  <p class="page-title">ìƒì‚°ì¼ì í™•ì¸</p>
  <p class="page-subtitle">ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì´¬ì˜í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</p>

  <div class="input-card">
    <button class="camera-btn" onclick="openCamera()">
      <span class="icon">ğŸ“·</span>
      <span>ì¹´ë©”ë¼ë¡œ ì´¬ì˜</span>
    </button>

    <button class="gallery-btn" onclick="openGallery()">
      <span class="icon">ğŸ–¼ï¸</span>
      <span>ì‚¬ì§„ì²©ì—ì„œ ì„ íƒ</span>
    </button>

    <div class="divider">ë˜ëŠ” ì§ì ‘ ì…ë ¥</div>

    <div class="manual-row">
      <input type="text" class="manual-input" id="serialInput"
             placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì…ë ¥ (CN...)" maxlength="25"
             autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
      <button class="check-btn" onclick="checkSerial()">ì¡°íšŒ</button>
    </div>

    <div class="ocr-status" id="ocrStatus"></div>

    <div class="divider">ë˜ëŠ” ë‚ ì§œì½”ë“œë§Œ ì…ë ¥</div>

    <button class="datecode-toggle" id="datecodeToggle" onclick="toggleDatecodeInput()">
      ğŸ”¤ ì—°Â·ì›”Â·ì¼ ì½”ë“œ 3ìë¦¬ë§Œ ì…ë ¥
    </button>

    <div class="datecode-section" id="datecodeSection">

      <!-- 10ìë¦¬ -->
      <div class="dc-row-card">
        <div class="dc-row-left">
          <div class="dc-format-badge">10ìë¦¬</div>
          <div class="dc-serial-diagram">CN XX <span class="dc-hl">Y M D</span> XXX</div>
          <div class="dc-pos-text">5Â·6Â·7ë²ˆì§¸</div>
        </div>
        <div class="dc-row-right">
          <div class="dc-inputs-group">
            <input type="text" class="datecode-input" id="dc10Y" maxlength="1" placeholder="Y"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc10M')">
            <input type="text" class="datecode-input" id="dc10M" maxlength="1" placeholder="M"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc10D')">
            <input type="text" class="datecode-input" id="dc10D" maxlength="1" placeholder="D"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,null)">
            <button class="dc-go-btn" onclick="checkDatecode('10ìë¦¬','dc10Y','dc10M','dc10D')">â–¶</button>
          </div>
        </div>
      </div>

      <!-- 25ìë¦¬ -->
      <div class="dc-row-card">
        <div class="dc-row-left">
          <div class="dc-format-badge badge-25">25ìë¦¬</div>
          <div class="dc-serial-diagram">â€¦XXXX <span class="dc-hl">Y M D</span> XXXX</div>
          <div class="dc-pos-text">19Â·20Â·21ë²ˆì§¸</div>
        </div>
        <div class="dc-row-right">
          <div class="dc-inputs-group">
            <input type="text" class="datecode-input" id="dc25Y" maxlength="1" placeholder="Y"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc25M')">
            <input type="text" class="datecode-input" id="dc25M" maxlength="1" placeholder="M"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc25D')">
            <input type="text" class="datecode-input" id="dc25D" maxlength="1" placeholder="D"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,null)">
            <button class="dc-go-btn" onclick="checkDatecode('25ìë¦¬','dc25Y','dc25M','dc25D')">â–¶</button>
          </div>
        </div>
      </div>

      <!-- 14ìë¦¬ -->
      <div class="dc-row-card">
        <div class="dc-row-left">
          <div class="dc-format-badge badge-14">14ìë¦¬</div>
          <div class="dc-serial-diagram">CN <span class="dc-hl">Y M D</span> XXXXXXXXX</div>
          <div class="dc-pos-text">3Â·4Â·5ë²ˆì§¸</div>
        </div>
        <div class="dc-row-right">
          <div class="dc-inputs-group">
            <input type="text" class="datecode-input" id="dc14Y" maxlength="1" placeholder="Y"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc14M')">
            <input type="text" class="datecode-input" id="dc14M" maxlength="1" placeholder="M"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,'dc14D')">
            <input type="text" class="datecode-input" id="dc14D" maxlength="1" placeholder="D"
                   autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
                   oninput="datecodeAutoNext(this,null)">
            <button class="dc-go-btn" onclick="checkDatecode('14ìë¦¬','dc14Y','dc14M','dc14D')">â–¶</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ì°¸ì¡°í‘œ ë³´ê¸° ë²„íŠ¼ -->
  <button class="ref-toggle-btn" id="refToggleBtn" onclick="toggleRefPanel()">
    <span>ğŸ“Š</span>
    <span>ì‹œë¦¬ì–¼ ì½”ë“œ ì°¸ì¡°í‘œ ë³´ê¸°</span>
    <span class="arrow">â–¼</span>
  </button>
</div>

<!-- ì°¸ì¡°í‘œ íŒ¨ë„ (í† ê¸€) -->
<div class="ref-panel" id="refPanel">

  <!-- â”â”â” ì„¹ì…˜ 1: 10ìë¦¬ â”â”â” -->
  <div class="ref-section-header">â‘  10ìë¦¬ ì‹œë¦¬ì–¼ (HPPS Code)</div>
  <div class="ref-section-pos">CN XX <b style="color:#0096D6;text-decoration:underline;">Y M D</b> XXX â†’ <b>5Â·6Â·7</b>ë²ˆì§¸</div>

  <div class="ref-table-title">ğŸ“… ì—°ë„ ì½”ë“œ (2011~2029)</div>
  <table class="ref-table">
    <tr><th>ì—°ë„</th><th>'11</th><th>'12</th><th>'13</th><th>'14</th><th>'15</th><th>'16</th><th>'17</th><th>'18</th><th>'19</th><th>'20</th></tr>
    <tr><th>ì½”ë“œ</th><td>C</td><td>D</td><td>F</td><td>G</td><td>H</td><td>J</td><td>K</td><td>L</td><td>M</td><td>N</td></tr>
    <tr><th>ì—°ë„</th><th>'21</th><th>'22</th><th>'23</th><th>'24</th><th>'25</th><th>'26</th><th>'27</th><th>'28</th><th>'29</th><th></th></tr>
    <tr><th>ì½”ë“œ</th><td>P</td><td>Q</td><td>R</td><td>S</td><td>T</td><td>V</td><td>W</td><td>X</td><td>Y</td><td></td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“† ì›” ì½”ë“œ</div>
  <table class="ref-table">
    <tr><th>ì›”</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr>
    <tr><th>ì½”ë“œ</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>B</td><td>C</td><td>D</td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“‹ ì¼ ì½”ë“œ (0 = 1ì¼)</div>
  <table class="ref-table">
    <tr><th>ì¼</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th></tr>
    <tr><th>ì½”ë“œ</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>B</td><td>C</td><td>D</td><td>F</td><td>G</td><td>H</td></tr>
    <tr><th>ì¼</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th><th></th></tr>
    <tr><th>ì½”ë“œ</th><td>J</td><td>K</td><td>L</td><td>M</td><td>N</td><td>P</td><td>Q</td><td>R</td><td>S</td><td>T</td><td>V</td><td>W</td><td>X</td><td>Y</td><td>Z</td><td></td></tr>
  </table>

  <div class="ref-section-divider"></div>

  <!-- â”â”â” ì„¹ì…˜ 2: 25ìë¦¬ â”â”â” -->
  <div class="ref-section-header">â‘¡ 25ìë¦¬ ì‹œë¦¬ì–¼ (E-PASS Label)</div>
  <div class="ref-section-pos">CN XXXXXXXXXXXXXXXX <b style="color:#0096D6;text-decoration:underline;">Y M D</b> XXXX â†’ <b>19Â·20Â·21</b>ë²ˆì§¸</div>

  <div class="ref-table-title">ğŸ“… ì—°ë„ ì½”ë“œ (2011~2030)</div>
  <table class="ref-table">
    <tr><th>ì—°ë„</th><th>'11</th><th>'12</th><th>'13</th><th>'14</th><th>'15</th><th>'16</th><th>'17</th><th>'18</th><th>'19</th><th>'20</th></tr>
    <tr><th>ì½”ë“œ</th><td>B</td><td>C</td><td>D</td><td>F</td><td>G</td><td>H</td><td>J</td><td>K</td><td>M</td><td>N</td></tr>
    <tr><th>ì—°ë„</th><th>'21</th><th>'22</th><th>'23</th><th>'24</th><th>'25</th><th>'26</th><th>'27</th><th>'28</th><th>'29</th><th>'30</th></tr>
    <tr><th>ì½”ë“œ</th><td>R</td><td>T</td><td>W</td><td>X</td><td>Y</td><td>L</td><td>P</td><td>Q</td><td>S</td><td>Z</td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“† ì›” ì½”ë“œ</div>
  <table class="ref-table">
    <tr><th>ì›”</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr>
    <tr><th>ì½”ë“œ</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>A</td><td>B</td><td>C</td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“‹ ì¼ ì½”ë“œ</div>
  <table class="ref-table">
    <tr><th>ì¼</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th></tr>
    <tr><th>ì½”ë“œ</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td></tr>
    <tr><th>ì¼</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th><th></th></tr>
    <tr><th>ì½”ë“œ</th><td>H</td><td>I</td><td>J</td><td>K</td><td>L</td><td>M</td><td>N</td><td>O</td><td>P</td><td>Q</td><td>R</td><td>S</td><td>T</td><td>U</td><td>V</td><td></td></tr>
  </table>

  <div class="ref-section-divider"></div>

  <!-- â”â”â” ì„¹ì…˜ 3: 14ìë¦¬ â”â”â” -->
  <div class="ref-section-header">â‘¢ 14ìë¦¬ ì‹œë¦¬ì–¼ (New Format)</div>
  <div class="ref-section-pos">CN <b style="color:#0096D6;text-decoration:underline;">Y M D</b> XXXXXXXXX â†’ <b>3Â·4Â·5</b>ë²ˆì§¸</div>

  <div class="ref-table-title">ğŸ“… ì—°ë„ ì½”ë“œ (2020~2029)</div>
  <table class="ref-table">
    <tr><th>ì—°ë„</th><th>'20</th><th>'21</th><th>'22</th><th>'23</th><th>'24</th><th>'25</th><th>'26</th><th>'27</th><th>'28</th><th>'29</th></tr>
    <tr><th>ì½”ë“œ</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“† ì›” ì½”ë“œ</div>
  <table class="ref-table">
    <tr><th>ì›”</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr>
    <tr><th>ì½”ë“œ</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>A</td><td>B</td><td>C</td></tr>
  </table>
  <div class="ref-table-title" style="margin-top:8px;">ğŸ“‹ ì¼ ì½”ë“œ</div>
  <table class="ref-table">
    <tr><th>ì¼</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th></tr>
    <tr><th>ì½”ë“œ</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td></tr>
    <tr><th>ì¼</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th><th></th></tr>
    <tr><th>ì½”ë“œ</th><td>H</td><td>I</td><td>J</td><td>K</td><td>L</td><td>M</td><td>N</td><td>O</td><td>P</td><td>Q</td><td>R</td><td>S</td><td>T</td><td>U</td><td>V</td><td></td></tr>
  </table>

</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment">
<input type="file" id="galleryInput" accept="image/*">
<canvas id="ocrCanvas"></canvas>

<!-- ì¹´ë©”ë¼ ê°€ì´ë“œë¼ì¸ ì˜¤ë²„ë ˆì´ -->
<div class="camera-overlay" id="cameraOverlay">
  <video id="cameraVideo" playsinline autoplay muted></video>
  <div class="camera-guide-layer">
    <!-- ê°€ì´ë“œ ë°•ìŠ¤ â€” JSì—ì„œ í¬ê¸° ì„¤ì • -->
    <div class="guide-box" id="guideBox">
      <div class="guide-centerline"></div>
      <div class="guide-inner-text">ë¼ë²¨ ì „ì²´ë¥¼ ë§ì¶°ì£¼ì„¸ìš”</div>
      <div class="guide-corner-bl"></div>
      <div class="guide-corner-br"></div>
    </div>
    <div class="guide-text-top" id="guideTextTop">ë°”ì½”ë“œ + ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ë°•ìŠ¤ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
    <div class="guide-text-hint" id="guideTextHint">ğŸ“ ë¼ë²¨ ì „ì²´ê°€ ë³´ì´ë„ë¡ Â· í”ë“¤ë¦¬ì§€ ì•Šê²Œ</div>
    <div class="flash-effect" id="flashEffect"></div>
  </div>
  <div class="camera-controls">
    <button class="close-camera-btn" onclick="closeCamera()">âœ•</button>
    <button class="shutter-btn" id="shutterBtn" onclick="capturePhoto()"></button>
    <div style="width:44px"></div><!-- ì¢Œìš° ê· í˜• ë§ì¶¤ -->
  </div>
</div>

<div class="result-card" id="resultCard"></div>

<div class="history-section" id="historySection">
  <div class="history-title">ğŸ“‹ ìµœê·¼ ì¡°íšŒ</div>
  <div id="historyList"></div>
</div>

<div class="bottom-spacer"></div>
<div class="footer">Made by <span>KSH</span><br><span style="font-size:10px;color:#c0c0c0;">v 0.10</span></div>

<!-- ë°”ì½”ë“œ/QR ì½”ë“œ ë¦¬ë” CDN -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Tesseract.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- ë°”ì½”ë“œ ë¦¬ë” ìˆ¨ê¹€ ì»¨í…Œì´ë„ˆ -->
<div id="barcodeReader" style="display:none;width:0;height:0;overflow:hidden;"></div>

<script>
// ========== ì½”ë”© í…Œì´ë¸” (3ê°€ì§€ í˜•ì‹ë³„ ê°œë³„ ê·œì¹™) ==========

// â”€â”€ 10ìë¦¬ Code â”€â”€ (ìœ„ì¹˜: 5Â·6Â·7ë²ˆì§¸)
const YEAR_10 = {
  'C':2011,'D':2012,'F':2013,'G':2014,'H':2015,'J':2016,'K':2017,'L':2018,'M':2019,'N':2020,
  'P':2021,'Q':2022,'R':2023,'S':2024,'T':2025,'V':2026,'W':2027,'X':2028,'Y':2029
};
const MONTH_10 = {
  '1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'B':10,'C':11,'D':12
};
const DAY_10 = {
  '0':1,'1':2,'2':3,'3':4,'4':5,'5':6,'6':7,'7':8,'8':9,'9':10,
  'B':11,'C':12,'D':13,'F':14,'G':15,'H':16,'J':17,'K':18,'L':19,'M':20,
  'N':21,'P':22,'Q':23,'R':24,'S':25,'T':26,'V':27,'W':28,'X':29,'Y':30,'Z':31
};

// â”€â”€ 25ìë¦¬ Code â”€â”€ (ìœ„ì¹˜: 19Â·20Â·21ë²ˆì§¸)
const YEAR_25 = {
  'B':2011,'C':2012,'D':2013,'F':2014,'G':2015,'H':2016,'J':2017,'K':2018,'M':2019,'N':2020,
  'R':2021,'T':2022,'W':2023,'X':2024,'Y':2025,'L':2026,'P':2027,'Q':2028,'S':2029,'Z':2030
};
const MONTH_25 = {
  '1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'A':10,'B':11,'C':12
};
const DAY_25 = {
  '1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
  'A':10,'B':11,'C':12,'D':13,'E':14,'F':15,'G':16,'H':17,'I':18,'J':19,'K':20,
  'L':21,'M':22,'N':23,'O':24,'P':25,'Q':26,'R':27,'S':28,'T':29,'U':30,'V':31
};

// â”€â”€ 14ìë¦¬ Code â”€â”€ (ìœ„ì¹˜: 3Â·4Â·5ë²ˆì§¸)
const YEAR_14 = {
  '0':2020,'1':2021,'2':2022,'3':2023,'4':2024,'5':2025,'6':2026,'7':2027,'8':2028,'9':2029
};
const MONTH_14 = {
  '1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'A':10,'B':11,'C':12
};
const DAY_14 = {
  '1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
  'A':10,'B':11,'C':12,'D':13,'E':14,'F':15,'G':16,'H':17,'I':18,'J':19,'K':20,
  'L':21,'M':22,'N':23,'O':24,'P':25,'Q':26,'R':27,'S':28,'T':29,'U':30,'V':31
};

// í˜•ì‹ë³„ í…Œì´ë¸” ë§¤í•‘
const CODE_TABLES = {
  '10ìë¦¬': { year: YEAR_10, month: MONTH_10, day: DAY_10 },
  '25ìë¦¬': { year: YEAR_25, month: MONTH_25, day: DAY_25 },
  '14ìë¦¬': { year: YEAR_14, month: MONTH_14, day: DAY_14 }
};

function decodeYear(ch, type) {
  const table = CODE_TABLES[type];
  return table ? (table.year[ch] || null) : null;
}
function decodeMonth(ch, type) {
  const table = CODE_TABLES[type];
  return table ? (table.month[ch] || null) : null;
}
function decodeDay(ch, type) {
  const table = CODE_TABLES[type];
  return table ? (table.day[ch] || null) : null;
}

const MONTH_NAMES = ['', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”',
                     '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

// ========== íŒŒì‹± í•¨ìˆ˜ ==========
function parseSerial(raw) {
  const s = raw.replace(/[\s\-]/g, '').toUpperCase();
  const len = s.length;

  if (len !== 10 && len !== 25 && len !== 14) {
    return { error: true, msg: `ì‹œë¦¬ì–¼ì€ 10ìë¦¬, 14ìë¦¬ ë˜ëŠ” 25ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤. (ì…ë ¥: ${len}ìë¦¬)` };
  }

  let yearChar, monthChar, dayChar;
  let serialType;

  if (len === 10) {
    serialType = '10ìë¦¬';
    yearChar = s[4];   // 5ë²ˆì§¸
    monthChar = s[5];  // 6ë²ˆì§¸
    dayChar = s[6];    // 7ë²ˆì§¸
  } else if (len === 25) {
    serialType = '25ìë¦¬';
    yearChar = s[18];  // 19ë²ˆì§¸
    monthChar = s[19]; // 20ë²ˆì§¸
    dayChar = s[20];   // 21ë²ˆì§¸
  } else {
    serialType = '14ìë¦¬';
    yearChar = s[2];   // 3ë²ˆì§¸
    monthChar = s[3];  // 4ë²ˆì§¸
    dayChar = s[4];    // 5ë²ˆì§¸
  }

  const year = decodeYear(yearChar, serialType);
  const month = decodeMonth(monthChar, serialType);
  const day = decodeDay(dayChar, serialType);

  if (!year) {
    return { error: true, msg: `[${serialType}] ì—°ë„ ì½”ë“œ '${yearChar}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` };
  }
  if (!month) {
    return { error: true, msg: `[${serialType}] ì›” ì½”ë“œ '${monthChar}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` };
  }
  if (!day) {
    return { error: true, msg: `[${serialType}] ì¼ ì½”ë“œ '${dayChar}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` };
  }

  const dateStr = `${year}.${String(month).padStart(2,'0')}.${String(day).padStart(2,'0')}`;
  const dayOfWeek = getDayOfWeek(year, month, day);

  return {
    error: false,
    serial: s,
    serialType,
    year, month, day,
    yearChar, monthChar, dayChar,
    dateStr,
    dayOfWeek,
    monthName: MONTH_NAMES[month]
  };
}

function getDayOfWeek(y, m, d) {
  const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const date = new Date(y, m - 1, d);
  return days[date.getDay()] + 'ìš”ì¼';
}

// ========== UI ==========

// OCR ì¸ì‹ ì‹œ í˜¼ë™í•˜ê¸° ì‰¬ìš´ ìœ ì‚¬ ë¬¸ì ê·¸ë£¹
const SIMILAR_CHARS = {
  'R': ['R','P','B','K'],
  'T': ['T','Y','7','F','I'],
  'W': ['W','M','N'],
  'X': ['X','K','Y'],
  'Y': ['Y','T','V','X'],
  'L': ['L','I','1','J'],
  'P': ['P','R','D','B'],
  'Q': ['Q','O','0','G','9'],
  'S': ['S','5','8','Z'],
  'Z': ['Z','2','S','7'],
  'B': ['B','8','D','R','P'],
  'C': ['C','G','O','0','('],
  'D': ['D','0','O','B','P'],
  'F': ['F','P','E','T'],
  'G': ['G','6','C','O','Q'],
  'H': ['H','N','M','K'],
  'J': ['J','I','1','T','L'],
  'K': ['K','X','R','H'],
  'M': ['M','N','W','H'],
  'N': ['N','M','H','W'],
  '1': ['1','I','L','7','T'],
  '2': ['2','Z','7'],
  '3': ['3','8','B'],
  '4': ['4','A','9'],
  '5': ['5','S','6'],
  '6': ['6','G','8','5'],
  '7': ['7','T','1','Z'],
  '8': ['8','B','3','S'],
  '9': ['9','Q','G','4'],
  'A': ['A','4','H','R'],
  'V': ['V','U','Y','W'],
  'I': ['I','1','L','T','J'],
  'O': ['O','0','Q','D','C'],
  '0': ['0','O','D','Q'],
};

// OCR ì¸ì‹ ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ í† ê¸€
function toggleOcrZoom(imgEl) {
  imgEl.classList.toggle('zoomed');
}

// íŠ¹ì • ì½”ë“œ ìœ í˜• + ì‹œë¦¬ì–¼ í˜•ì‹ì— ëŒ€í•œ ìœ íš¨ ë¬¸ìë§Œ í•„í„°ë§
function getCandidates(ch, type, serialType) {
  const similar = SIMILAR_CHARS[ch] || [ch];
  const allCandidates = [ch, ...similar.filter(c => c !== ch)];

  const tables = CODE_TABLES[serialType];
  if (!tables) return allCandidates;

  if (type === 'year') {
    return allCandidates.filter(c => tables.year[c]);
  } else if (type === 'month') {
    return allCandidates.filter(c => tables.month[c]);
  } else if (type === 'day') {
    return allCandidates.filter(c => tables.day[c]);
  }
  return allCandidates;
}

// í˜„ì¬ ê²°ê³¼ ìƒíƒœ (ì‚¬ìš©ì ë³´ì •ì— ì‚¬ìš©)
let currentResultState = null;
// OCR ì¸ì‹ì— ì‚¬ìš©ëœ ì›ë³¸ ì´ë¯¸ì§€ (í¬ë¡­ëœ ìº”ë²„ìŠ¤ì˜ dataURL)
let lastOcrImageDataUrl = null;
let lastOcrData = null;    // Tesseract ì¸ì‹ ê²°ê³¼ (ë°”ìš´ë”©ë°•ìŠ¤)
let lastOcrCanvas = null;  // OCRì— ì‚¬ìš©ëœ ìº”ë²„ìŠ¤
let lastBarcodeSerial = null;  // ë°”ì½”ë“œ ì¸ì‹ ê²°ê³¼ (ìˆì„ ë•Œë§Œ)
let lastOcrSerial = null;      // OCR ë¬¸ì ì¸ì‹ ê²°ê³¼ (ìˆì„ ë•Œë§Œ)

// OCR ê²°ê³¼ì—ì„œ ì‹œë¦¬ì–¼ í…ìŠ¤íŠ¸ ì˜ì—­ë§Œ í¬ë¡­ + YMD ë¶‰ì€ ë°‘ì¤„ ì˜¤ë²„ë ˆì´
function buildCroppedSerialPreview(srcCanvas, ocrData, serial) {
  try {
    const sLen = serial.length;

    // YMD ìœ„ì¹˜ (0-indexed)
    let ymdStart, ymdEnd;
    if (sLen === 10)      { ymdStart = 4; ymdEnd = 7; }
    else if (sLen === 14) { ymdStart = 2; ymdEnd = 5; }
    else if (sLen === 25) { ymdStart = 18; ymdEnd = 21; }
    else                  { ymdStart = 0; ymdEnd = sLen; }

    // Tesseract wordsì—ì„œ ì‹œë¦¬ì–¼ì´ í¬í•¨ëœ ì¤„ì˜ ë°”ìš´ë”©ë°•ìŠ¤ ì°¾ê¸°
    let bestLine = null;
    let bestSymbols = null;

    if (ocrData && ocrData.lines) {
      for (const line of ocrData.lines) {
        const lineText = line.text.replace(/[^A-Z0-9]/gi, '').toUpperCase();
        if (lineText.includes(serial.slice(0, 6))) {
          bestLine = line.bbox;
          // ì‹¬ë³¼ ë ˆë²¨ ë°”ìš´ë”© ë°•ìŠ¤ ìˆ˜ì§‘ (ê¸€ì í•˜ë‚˜í•˜ë‚˜)
          const symbols = [];
          for (const word of line.words) {
            for (const sym of (word.symbols || [])) {
              symbols.push(sym);
            }
          }
          bestSymbols = symbols;
          break;
        }
      }
    }

    const cW = srcCanvas.width;
    const cH = srcCanvas.height;

    // í¬ë¡­ ì˜ì—­ ê²°ì •
    let cropX, cropY, cropW, cropH;
    if (bestLine) {
      const lineH = bestLine.y1 - bestLine.y0;
      const lineW = bestLine.x1 - bestLine.x0;
      const padY = Math.round(lineH * 0.6);            // ìƒí•˜ ì—¬ë°±
      const padX = Math.round(Math.max(lineW * 0.15, lineH * 1.0)); // ì¢Œìš° ì—¬ë°± ë„‰ë„‰í•˜ê²Œ
      cropX = Math.max(0, bestLine.x0 - padX);
      cropY = Math.max(0, bestLine.y0 - padY);
      cropW = Math.min(cW - cropX, lineW + padX * 2);
      cropH = Math.min(cH - cropY, lineH + padY * 2);
    } else {
      // ë°”ìš´ë”©ë°•ìŠ¤ ëª» ì°¾ìœ¼ë©´ ì¤‘ì•™ 50% í¬ë¡­
      cropX = Math.round(cW * 0.05);
      cropY = Math.round(cH * 0.25);
      cropW = Math.round(cW * 0.9);
      cropH = Math.round(cH * 0.5);
    }

    // í¬ë¡­ ìº”ë²„ìŠ¤ ìƒì„±
    const cropCanvas = document.createElement('canvas');
    cropCanvas.width = cropW;
    cropCanvas.height = cropH;
    const cropCtx = cropCanvas.getContext('2d');
    cropCtx.drawImage(srcCanvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

    // YMD ì˜ì—­ì— ë¶‰ì€ ë°‘ì¤„ ê·¸ë¦¬ê¸°
    // ì‹¬ë³¼ ë°”ìš´ë”©ë°•ìŠ¤ ì‚¬ìš© or ê¸€ì ìˆ˜ ë¹„ìœ¨ë¡œ ì¶”ì •
    let ulX0, ulX1, ulY;

    if (bestSymbols && bestSymbols.length > 0) {
      // ì‹œë¦¬ì–¼ ë¬¸ìì—´ê³¼ ì‹¬ë³¼ì„ ë§¤ì¹­í•˜ì—¬ ìœ„ì¹˜ ì¶”ì •
      // ë¼ì¸ ë‚´ ì•ŒíŒŒë²³/ìˆ«ì ì‹¬ë³¼ë§Œ í•„í„°
      const alphaSyms = bestSymbols.filter(sym => /[A-Z0-9]/i.test(sym.text));
      
      // CNìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ìœ„ì¹˜ ì°¾ê¸°
      let cnIdx = -1;
      for (let i = 0; i <= alphaSyms.length - sLen; i++) {
        const chunk = alphaSyms.slice(i, i + Math.min(4, sLen)).map(s => s.text).join('').toUpperCase();
        if (chunk.startsWith(serial.slice(0, Math.min(4, sLen)))) {
          cnIdx = i;
          break;
        }
      }

      if (cnIdx >= 0 && cnIdx + ymdEnd <= alphaSyms.length) {
        const symStart = alphaSyms[cnIdx + ymdStart];
        const symEnd = alphaSyms[cnIdx + ymdEnd - 1];
        ulX0 = symStart.bbox.x0 - cropX;
        ulX1 = symEnd.bbox.x1 - cropX;
        ulY = symEnd.bbox.y1 - cropY;
      }
    }

    // ì‹¬ë³¼ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ë¹„ìœ¨ë¡œ ì¶”ì •
    if (ulX0 === undefined) {
      const lineLeft = bestLine ? bestLine.x0 - cropX : 0;
      const lineWidth = bestLine ? (bestLine.x1 - bestLine.x0) : cropW;
      const charWidth = lineWidth / sLen;
      ulX0 = lineLeft + charWidth * ymdStart;
      ulX1 = lineLeft + charWidth * ymdEnd;
      ulY = cropH * 0.78;
    }

    // ë¶‰ì€ ë°‘ì¤„ ê·¸ë¦¬ê¸°
    const lineThickness = Math.max(3, Math.round(cropH * 0.06));
    cropCtx.strokeStyle = 'rgba(220, 38, 38, 0.85)';
    cropCtx.lineWidth = lineThickness;
    cropCtx.lineCap = 'round';
    cropCtx.beginPath();
    cropCtx.moveTo(ulX0, ulY + 2);
    cropCtx.lineTo(ulX1, ulY + 2);
    cropCtx.stroke();

    // ë°˜íˆ¬ëª… ë°°ê²½ í•˜ì´ë¼ì´íŠ¸ (ë°‘ì¤„ ìœ„)
    cropCtx.fillStyle = 'rgba(220, 38, 38, 0.10)';
    const hlTop = bestLine ? (bestLine.y0 - cropY) : 0;
    cropCtx.fillRect(ulX0, hlTop, ulX1 - ulX0, ulY + 2 - hlTop);

    return cropCanvas.toDataURL('image/jpeg', 0.9);
  } catch (e) {
    console.warn('[í¬ë¡­ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨]', e);
    // í´ë°±: ì „ì²´ ìº”ë²„ìŠ¤ ì´ë¯¸ì§€
    return srcCanvas.toDataURL('image/jpeg', 0.85);
  }
}

function showResult(result, isFromOCR = false) {
  const card = document.getElementById('resultCard');

  if (result.error) {
    card.innerHTML = `<div class="error-msg">âŒ ${result.msg}</div>`;
    card.classList.add('show');
    return;
  }

  // ìƒíƒœ ì €ì¥
  currentResultState = { ...result, isFromOCR };

  // ì‹œë¦¬ì–¼ì—ì„œ ë‚ ì§œ ë¶€ë¶„ í•˜ì´ë¼ì´íŠ¸
  let serialHtml = '';
  const s = result.serial;
  if (result.serialType === 'ì½”ë“œ 3ìë¦¬') {
    serialHtml = `<span style="color:#fff;font-weight:700;text-decoration:underline">${s}</span>`;
  } else if (result.serialType === '10ìë¦¬') {
    serialHtml = `${s.slice(0,4)}<span style="color:#fff;font-weight:700;text-decoration:underline">${s.slice(4,7)}</span>${s.slice(7)}`;
  } else if (result.serialType === '14ìë¦¬') {
    serialHtml = `${s.slice(0,2)}<span style="color:#fff;font-weight:700;text-decoration:underline">${s.slice(2,5)}</span>${s.slice(5)}`;
  } else {
    serialHtml = `${s.slice(0,18)}<span style="color:#fff;font-weight:700;text-decoration:underline">${s.slice(18,21)}</span>${s.slice(21)}`;
  }

  // ìœ ì‚¬ ë¬¸ì í›„ë³´ ìƒì„± (ì‹œë¦¬ì–¼ í˜•ì‹ì— ë”°ë¼ ìœ íš¨ ë¬¸ì í•„í„°ë§)
  const sType = result.serialType === 'ì½”ë“œ 3ìë¦¬' ? (currentResultState && currentResultState.dcFormat || '10ìë¦¬') : result.serialType;
  const yearCandidates = getCandidates(result.yearChar, 'year', sType);
  const monthCandidates = getCandidates(result.monthChar, 'month', sType);
  const dayCandidates = getCandidates(result.dayChar, 'day', sType);

  // í›„ë³´ê°€ 2ê°œ ì´ìƒì¸ ì½”ë“œê°€ ìˆìœ¼ë©´ ì„ íƒ UI í‘œì‹œ
  const hasAmbiguity = isFromOCR && (yearCandidates.length > 1 || monthCandidates.length > 1 || dayCandidates.length > 1);

  // ì—°ë„ í›„ë³´ ì˜µì…˜ HTML
  function makeOptions(candidates, currentChar, type) {
    return candidates.map(c => {
      let decoded = '';
      if (type === 'year') decoded = decodeYear(c, sType) + 'ë…„';
      else if (type === 'month') decoded = decodeMonth(c, sType) + 'ì›”';
      else if (type === 'day') decoded = decodeDay(c, sType) + 'ì¼';

      const isSelected = c === currentChar ? 'selected' : '';
      const isOriginal = c === currentChar ? 'ocr-original' : '';
      return `<button class="char-option ${isSelected} ${isOriginal}" data-char="${c}" data-type="${type}" onclick="pickChar(this)">
        <span class="char-code">${c}</span><span class="char-decoded">${decoded}</span>
      </button>`;
    }).join('');
  }

  let pickerHtml = '';
  if (hasAmbiguity) {
    pickerHtml = `
      <div class="char-picker-section">
        <div class="char-picker-title">âš ï¸ OCR ì¸ì‹ì´ ì• ë§¤í•œ ë¬¸ì â€” íƒ­í•˜ì—¬ ë³€ê²½</div>
        ${yearCandidates.length > 1 ? `
        <div class="char-picker-row">
          <span class="char-picker-label">ì—°ë„ ì½”ë“œ</span>
          <div class="char-picker-options" id="yearPicker">${makeOptions(yearCandidates, result.yearChar, 'year')}</div>
        </div>` : ''}
        ${monthCandidates.length > 1 ? `
        <div class="char-picker-row">
          <span class="char-picker-label">ì›” ì½”ë“œ</span>
          <div class="char-picker-options" id="monthPicker">${makeOptions(monthCandidates, result.monthChar, 'month')}</div>
        </div>` : ''}
        ${dayCandidates.length > 1 ? `
        <div class="char-picker-row">
          <span class="char-picker-label">ì¼ ì½”ë“œ</span>
          <div class="char-picker-options" id="dayPicker">${makeOptions(dayCandidates, result.dayChar, 'day')}</div>
        </div>` : ''}
      </div>
    `;
  }

  // OCR ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í•­ìƒ í‘œì‹œ)
  let ocrPreviewHtml = '';
  if (lastOcrImageDataUrl) {
    ocrPreviewHtml = `
      <div class="ocr-preview-section">
        <div class="ocr-preview-label">ğŸ“· ì¸ì‹ëœ ì´ë¯¸ì§€ (<span class="ymd-mark"></span> = ì—°Â·ì›”Â·ì¼)</div>
        <div class="ocr-preview-wrap">
          <img src="${lastOcrImageDataUrl}" class="ocr-preview-img" alt="OCR í¬ë¡­" onclick="toggleOcrZoom(this)">
        </div>
        <div class="ocr-preview-hint">ì¸ì‹ëœ ë¬¸ìê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš” Â· íƒ­í•˜ì—¬ í™•ëŒ€</div>
      </div>
    `;
  }

  // ë°”ì½”ë“œ/OCR ì¸ì‹ ì¶œì²˜ í‘œì‹œ
  let sourceHtml = '';
  if (lastBarcodeSerial || lastOcrSerial) {
    let rows = '';
    const bothExist = lastBarcodeSerial && lastOcrSerial;
    const isDifferent = bothExist && lastBarcodeSerial !== lastOcrSerial;

    if (lastBarcodeSerial) {
      rows += `
        <div class="source-row">
          <span class="source-badge barcode">ë°”ì½”ë“œ</span>
          <span class="source-serial active">${lastBarcodeSerial}</span>
          <span class="source-label">âœ… ì±„íƒ</span>
        </div>`;
    }
    if (lastOcrSerial) {
      rows += `
        <div class="source-row">
          <span class="source-badge ocr">ë¬¸ì(OCR)</span>
          <span class="source-serial ${isDifferent ? 'muted' : (!lastBarcodeSerial ? 'active' : '')}">${lastOcrSerial}</span>
          ${isDifferent ? '<span class="source-label" style="color:#dc2626;">âš ï¸ ë¶ˆì¼ì¹˜</span>' : (!lastBarcodeSerial ? '<span class="source-label">âœ… ì±„íƒ</span>' : '')}
        </div>`;
    }
    if (rows) {
      sourceHtml = `<div class="recognition-source">${rows}</div>`;
    }
  }

  card.innerHTML = `
    <div class="result-header">
      <span class="badge">${result.serialType}</span>
      <span class="serial-text" id="resultSerialText">${serialHtml}</span>
    </div>
    ${sourceHtml}
    ${ocrPreviewHtml}
    <div class="date-display" id="resultDateDisplay">
      <div class="label">ìƒ ì‚° ì¼ ì</div>
      <div class="date" id="resultDate">${result.dateStr}</div>
      <div class="date-sub" id="resultDateSub">${result.year}ë…„ ${result.monthName} ${result.day}ì¼ (${result.dayOfWeek})</div>
    </div>
    ${pickerHtml}
    <div class="detail-section">
      <div class="detail-title">ğŸ“ íŒŒì‹± ê·¼ê±°</div>
      <div class="detail-row">
        <span class="key">ì—°ë„ ì½”ë“œ</span>
        <span class="val" id="detailYear"><span class="highlight">${result.yearChar}</span> â†’ ${result.year}ë…„</span>
      </div>
      <div class="detail-row">
        <span class="key">ì›” ì½”ë“œ</span>
        <span class="val" id="detailMonth"><span class="highlight">${result.monthChar}</span> â†’ ${result.month}ì›”</span>
      </div>
      <div class="detail-row">
        <span class="key">ì¼ ì½”ë“œ</span>
        <span class="val" id="detailDay"><span class="highlight">${result.dayChar}</span> â†’ ${result.day}ì¼</span>
      </div>
      <div class="detail-row">
        <span class="key">ì‹œë¦¬ì–¼ íƒ€ì…</span>
        <span class="val">${result.serialType}${result.serialType === '10ìë¦¬' ? ' (HPPS Code)' : result.serialType === '25ìë¦¬' ? ' (E-PASS Label)' : result.serialType === '14ìë¦¬' ? ' (New Format)' : ' (YMD ì§ì ‘ ì…ë ¥)'}</span>
      </div>
    </div>
  `;
  card.classList.add('show');

  // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
  addHistory(result.serial, result.dateStr);
}

// ì‚¬ìš©ìê°€ ì• ë§¤í•œ ë¬¸ìë¥¼ íƒ­í•˜ì—¬ ì„ íƒ
function pickChar(btn) {
  const type = btn.dataset.type;
  const char = btn.dataset.char;

  // ê°™ì€ íƒ€ì…ì˜ ëª¨ë“  ë²„íŠ¼ì—ì„œ selected ì œê±°
  const container = btn.parentElement;
  container.querySelectorAll('.char-option').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
  if (!currentResultState) return;

  const s = currentResultState.serial;
  let newSerial = s;

  if (type === 'year') {
    currentResultState.yearChar = char;
    if (currentResultState.serialType === '10ìë¦¬') {
      newSerial = s.slice(0,4) + char + s.slice(5);
    } else if (currentResultState.serialType === '14ìë¦¬') {
      newSerial = s.slice(0,2) + char + s.slice(3);
    } else {
      newSerial = s.slice(0,18) + char + s.slice(19);
    }
  } else if (type === 'month') {
    currentResultState.monthChar = char;
    if (currentResultState.serialType === '10ìë¦¬') {
      newSerial = s.slice(0,5) + char + s.slice(6);
    } else if (currentResultState.serialType === '14ìë¦¬') {
      newSerial = s.slice(0,3) + char + s.slice(4);
    } else {
      newSerial = s.slice(0,19) + char + s.slice(20);
    }
  } else if (type === 'day') {
    currentResultState.dayChar = char;
    if (currentResultState.serialType === '10ìë¦¬') {
      newSerial = s.slice(0,6) + char + s.slice(7);
    } else if (currentResultState.serialType === '14ìë¦¬') {
      newSerial = s.slice(0,4) + char + s.slice(5);
    } else {
      newSerial = s.slice(0,20) + char + s.slice(21);
    }
  }

  currentResultState.serial = newSerial;

  // ë””ì½”ë“œ (í˜•ì‹ì— ë§ëŠ” í…Œì´ë¸” ì‚¬ìš©)
  const st = currentResultState.serialType === 'ì½”ë“œ 3ìë¦¬' ? (currentResultState.dcFormat || '10ìë¦¬') : currentResultState.serialType;
  const year = decodeYear(currentResultState.yearChar, st);
  const month = decodeMonth(currentResultState.monthChar, st);
  const day = decodeDay(currentResultState.dayChar, st);

  if (year) currentResultState.year = year;
  if (month) currentResultState.month = month;
  if (day) currentResultState.day = day;

  currentResultState.dateStr = `${currentResultState.year}.${String(currentResultState.month).padStart(2,'0')}.${String(currentResultState.day).padStart(2,'0')}`;
  currentResultState.dayOfWeek = getDayOfWeek(currentResultState.year, currentResultState.month, currentResultState.day);
  currentResultState.monthName = MONTH_NAMES[currentResultState.month];

  // UI ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì„ ì—†ì´)
  const dateEl = document.getElementById('resultDate');
  const dateSubEl = document.getElementById('resultDateSub');
  const detailYearEl = document.getElementById('detailYear');
  const detailMonthEl = document.getElementById('detailMonth');
  const detailDayEl = document.getElementById('detailDay');
  const serialTextEl = document.getElementById('resultSerialText');

  if (dateEl) {
    dateEl.textContent = currentResultState.dateStr;
    // ë‚ ì§œ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜
    dateEl.style.transition = 'transform 0.15s, color 0.15s';
    dateEl.style.transform = 'scale(1.05)';
    dateEl.style.color = '#0096D6';
    setTimeout(() => {
      dateEl.style.transform = 'scale(1)';
      dateEl.style.color = '#059669';
    }, 200);
  }
  if (dateSubEl) dateSubEl.textContent = `${currentResultState.year}ë…„ ${currentResultState.monthName} ${currentResultState.day}ì¼ (${currentResultState.dayOfWeek})`;
  if (detailYearEl) detailYearEl.innerHTML = `<span class="highlight">${currentResultState.yearChar}</span> â†’ ${currentResultState.year}ë…„`;
  if (detailMonthEl) detailMonthEl.innerHTML = `<span class="highlight">${currentResultState.monthChar}</span> â†’ ${currentResultState.month}ì›”`;
  if (detailDayEl) detailDayEl.innerHTML = `<span class="highlight">${currentResultState.dayChar}</span> â†’ ${currentResultState.day}ì¼`;

  // ì‹œë¦¬ì–¼ í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
  if (serialTextEl) {
    const ns = currentResultState.serial;
    if (currentResultState.serialType === '10ìë¦¬') {
      serialTextEl.innerHTML = `${ns.slice(0,4)}<span style="color:#fff;font-weight:700;text-decoration:underline">${ns.slice(4,7)}</span>${ns.slice(7)}`;
    } else if (currentResultState.serialType === '14ìë¦¬') {
      serialTextEl.innerHTML = `${ns.slice(0,2)}<span style="color:#fff;font-weight:700;text-decoration:underline">${ns.slice(2,5)}</span>${ns.slice(5)}`;
    } else {
      serialTextEl.innerHTML = `${ns.slice(0,18)}<span style="color:#fff;font-weight:700;text-decoration:underline">${ns.slice(18,21)}</span>${ns.slice(21)}`;
    }
  }

  // ì…ë ¥ì°½ë„ ì—…ë°ì´íŠ¸
  document.getElementById('serialInput').value = newSerial;

  // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
  addHistory(currentResultState.serial, currentResultState.dateStr);
}

function checkSerial() {
  const input = document.getElementById('serialInput').value.trim();
  if (!input) {
    alert('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  // ìˆ˜ë™ ì…ë ¥ ì‹œ ë°”ì½”ë“œ/OCR ìƒíƒœ ì´ˆê¸°í™”
  lastBarcodeSerial = null;
  lastOcrSerial = null;
  lastOcrImageDataUrl = null;
  const result = parseSerial(input);
  showResult(result, false); // ìˆ˜ë™ ì…ë ¥ â€” í›„ë³´ ì„ íƒ ë¶ˆí•„ìš”
}

// ========== ë‚ ì§œì½”ë“œ 3ìë¦¬ ì…ë ¥ ==========
function toggleDatecodeInput() {
  const btn = document.getElementById('datecodeToggle');
  const section = document.getElementById('datecodeSection');
  btn.classList.toggle('open');
  section.classList.toggle('active');
  if (section.classList.contains('active')) {
    document.getElementById('dc10Y').focus();
  }
}

function datecodeAutoNext(current, nextId) {
  // ëŒ€ë¬¸ì ë³€í™˜
  current.value = current.value.toUpperCase();
  if (current.value.length === 1 && nextId) {
    document.getElementById(nextId).focus();
  }
}

let selectedDcFormat = '10ìë¦¬';

function checkDatecode(format, yId, mId, dId) {
  const yc = document.getElementById(yId).value.trim().toUpperCase();
  const mc = document.getElementById(mId).value.trim().toUpperCase();
  const dc = document.getElementById(dId).value.trim().toUpperCase();

  selectedDcFormat = format;

  if (!yc || !mc || !dc) {
    alert('ì—°ë„(Y), ì›”(M), ì¼(D) ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const year = decodeYear(yc, format);
  const month = decodeMonth(mc, format);
  const day = decodeDay(dc, format);

  if (!year) { alert(`[${format}] ì—°ë„ ì½”ë“œ '${yc}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }
  if (!month) { alert(`[${format}] ì›” ì½”ë“œ '${mc}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }
  if (!day) { alert(`[${format}] ì¼ ì½”ë“œ '${dc}' ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }

  const dateStr = `${year}.${String(month).padStart(2,'0')}.${String(day).padStart(2,'0')}`;
  const dayOfWeek = getDayOfWeek(year, month, day);

  const result = {
    error: false,
    serial: yc + mc + dc,
    serialType: 'ì½”ë“œ 3ìë¦¬',
    dcFormat: selectedDcFormat,
    year, month, day,
    yearChar: yc, monthChar: mc, dayChar: dc,
    dateStr,
    dayOfWeek,
    monthName: MONTH_NAMES[month]
  };

  showResult(result, false);
}

// Enter í‚¤
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('serialInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') checkSerial();
  });
  // ë‚ ì§œì½”ë“œ ì…ë ¥ Enter í‚¤ (3ê°€ì§€ í˜•ì‹ ê°ê°)
  const dcRows = [
    { ids: ['dc10Y','dc10M','dc10D'], fmt: '10ìë¦¬' },
    { ids: ['dc25Y','dc25M','dc25D'], fmt: '25ìë¦¬' },
    { ids: ['dc14Y','dc14M','dc14D'], fmt: '14ìë¦¬' }
  ];
  dcRows.forEach(row => {
    row.ids.forEach(id => {
      document.getElementById(id).addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkDatecode(row.fmt, row.ids[0], row.ids[1], row.ids[2]);
      });
    });
  });
  loadHistory();
});

// ========== ì°¸ì¡°í‘œ í† ê¸€ ==========
function toggleRefPanel() {
  const btn = document.getElementById('refToggleBtn');
  const panel = document.getElementById('refPanel');
  btn.classList.toggle('open');
  panel.classList.toggle('open');
}

// ========== ì¹´ë©”ë¼ (ì‹¤ì‹œê°„ ê°€ì´ë“œë¼ì¸) + ê°¤ëŸ¬ë¦¬ + OCR ==========

let cameraStream = null;

async function openCamera() {
  const overlay = document.getElementById('cameraOverlay');
  const video = document.getElementById('cameraVideo');

  try {
    // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });

    cameraStream = stream;
    video.srcObject = stream;
    await video.play();

    overlay.classList.add('active');
    updateGuideBox();

    // í™”ë©´ ë°©í–¥ ë³€ê²½ ì‹œ ê°€ì´ë“œ ë°•ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸
    window.addEventListener('resize', updateGuideBox);

  } catch (err) {
    console.warn('[ì¹´ë©”ë¼ ì§ì ‘ ì ‘ê·¼ ì‹¤íŒ¨]', err.message);
    // í´ë°±: ê¸°ì¡´ file input ë°©ì‹
    document.getElementById('cameraInput').click();
  }
}

function updateGuideBox() {
  const guideBox = document.getElementById('guideBox');
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  // ê°€ì´ë“œ ë°•ìŠ¤: ë°”ì½”ë“œ + ì‹œë¦¬ì–¼ í…ìŠ¤íŠ¸ ë¼ë²¨ ì „ì²´ë¥¼ í¬í•¨í•  ìˆ˜ ìˆëŠ” í¬ê¸°
  const boxW = Math.min(vw * 0.92, 600);
  const boxH = Math.max(boxW * 0.55, 160);  // ê°€ë¡œ ëŒ€ë¹„ ì•½ 55% ë†’ì´ â†’ ë¼ë²¨ ì „ì²´ í¬í•¨

  guideBox.style.width = boxW + 'px';
  guideBox.style.height = boxH + 'px';

  // ê°€ì´ë“œ í…ìŠ¤íŠ¸ ìœ„ì¹˜
  const guideTextTop = document.getElementById('guideTextTop');
  const guideTextHint = document.getElementById('guideTextHint');
  guideTextTop.style.bottom = `calc(50% + ${boxH / 2 + 20}px)`;
  guideTextHint.style.top = `calc(50% + ${boxH / 2 + 14}px)`;
}

function closeCamera() {
  const overlay = document.getElementById('cameraOverlay');
  const video = document.getElementById('cameraVideo');

  overlay.classList.remove('active');

  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  video.srcObject = null;
  window.removeEventListener('resize', updateGuideBox);
}

async function capturePhoto() {
  const video = document.getElementById('cameraVideo');
  const guideBox = document.getElementById('guideBox');
  const flashEl = document.getElementById('flashEffect');

  // í”Œë˜ì‹œ íš¨ê³¼
  flashEl.classList.add('flash');
  setTimeout(() => flashEl.classList.remove('flash'), 200);

  // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ìº¡ì²˜
  const vw = video.videoWidth;
  const vh = video.videoHeight;

  // í™”ë©´ ê¸°ì¤€ ê°€ì´ë“œ ë°•ìŠ¤ ìœ„ì¹˜ ê³„ì‚°
  const overlayRect = document.getElementById('cameraOverlay').getBoundingClientRect();
  const boxRect = guideBox.getBoundingClientRect();

  // ë¹„ë””ì˜¤ê°€ object-fit:cover ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì‹¤ì œ ë¹„ë””ì˜¤ ì˜ì—­ ê³„ì‚°
  const dispW = overlayRect.width;
  const dispH = overlayRect.height;
  const vidAspect = vw / vh;
  const dispAspect = dispW / dispH;

  let renderW, renderH, offsetX, offsetY;
  if (vidAspect > dispAspect) {
    // ë¹„ë””ì˜¤ê°€ ë” ë„“ìŒ â†’ ì¢Œìš° ì˜ë¦¼
    renderH = dispH;
    renderW = dispH * vidAspect;
    offsetX = (renderW - dispW) / 2;
    offsetY = 0;
  } else {
    // ë¹„ë””ì˜¤ê°€ ë” ë†’ìŒ â†’ ìƒí•˜ ì˜ë¦¼
    renderW = dispW;
    renderH = dispW / vidAspect;
    offsetX = 0;
    offsetY = (renderH - dispH) / 2;
  }

  // ê°€ì´ë“œ ë°•ìŠ¤ ì˜ì—­ì„ ë¹„ë””ì˜¤ ì¢Œí‘œë¡œ ë³€í™˜
  const scaleX = vw / renderW;
  const scaleY = vh / renderH;

  // ì—¬ìœ ë¶„ ì¶”ê°€ (ìœ„ì•„ë˜ 15%, ì¢Œìš° 5%) â€” í° ê°€ì´ë“œ ë°•ìŠ¤ì— ë§ê²Œ ì•½ê°„ì˜ ì—¬ìœ ë§Œ
  const marginX = boxRect.width * 0.05;
  const marginY = boxRect.height * 0.15;

  let cropX = (boxRect.left - overlayRect.left + offsetX - marginX) * scaleX;
  let cropY = (boxRect.top - overlayRect.top + offsetY - marginY) * scaleY;
  let cropW = (boxRect.width + marginX * 2) * scaleX;
  let cropH = (boxRect.height + marginY * 2) * scaleY;

  // ë²”ìœ„ í´ë¨í•‘
  cropX = Math.max(0, Math.round(cropX));
  cropY = Math.max(0, Math.round(cropY));
  cropW = Math.min(vw - cropX, Math.round(cropW));
  cropH = Math.min(vh - cropY, Math.round(cropH));

  // ê°€ì´ë“œ ì˜ì—­ë§Œ í¬ë¡­í•˜ì—¬ ìº¡ì²˜
  const captureCanvas = document.createElement('canvas');
  captureCanvas.width = cropW;
  captureCanvas.height = cropH;
  const capCtx = captureCanvas.getContext('2d');
  capCtx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

  // ì¹´ë©”ë¼ ë‹«ê¸°
  closeCamera();

  // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜ â†’ OCR ì²˜ë¦¬
  captureCanvas.toBlob(async (blob) => {
    if (!blob) return;
    const file = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
    await processImageFile(file);
  }, 'image/jpeg', 0.95);
}

function openGallery() {
  document.getElementById('galleryInput').click();
}

// ========== ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ==========

// ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
function toGrayscale(imageData) {
  const d = imageData.data;
  for (let i = 0; i < d.length; i += 4) {
    const gray = 0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2];
    d[i] = d[i+1] = d[i+2] = gray;
  }
}

// ì–¸ìƒ¤í”„ ë§ˆìŠ¤í¬ (ë¸”ëŸ¬í•œ ì´ë¯¸ì§€ì™€ ì°¨ì´ë¡œ ì„ ëª…í•˜ê²Œ)
function sharpen(canvas, ctx, amount = 1.5) {
  const w = canvas.width, h = canvas.height;
  const src = ctx.getImageData(0, 0, w, h);
  const dst = ctx.createImageData(w, h);
  const sd = src.data, dd = dst.data;

  const k = amount;
  for (let y = 1; y < h - 1; y++) {
    for (let x = 1; x < w - 1; x++) {
      const idx = (y * w + x) * 4;
      for (let c = 0; c < 3; c++) {
        const val = sd[idx + c] * (1 + 4 * k)
          - sd[((y-1)*w + x)*4 + c] * k
          - sd[((y+1)*w + x)*4 + c] * k
          - sd[(y*w + x-1)*4 + c] * k
          - sd[(y*w + x+1)*4 + c] * k;
        dd[idx + c] = Math.min(255, Math.max(0, val));
      }
      dd[idx + 3] = 255;
    }
  }
  ctx.putImageData(dst, 0, 0);
}

// ëŒ€ë¹„ ê°•í™” (íˆìŠ¤í† ê·¸ë¨ ìŠ¤íŠ¸ë ˆì¹­ + ê°ë§ˆ)
function enhanceContrast(imageData, gamma = 0.8) {
  const d = imageData.data;
  let minVal = 255, maxVal = 0;
  for (let i = 0; i < d.length; i += 4) {
    if (d[i] < minVal) minVal = d[i];
    if (d[i] > maxVal) maxVal = d[i];
  }
  const range = maxVal - minVal || 1;
  for (let i = 0; i < d.length; i += 4) {
    let norm = (d[i] - minVal) / range;
    norm = Math.pow(norm, gamma);
    const val = norm * 255;
    d[i] = d[i+1] = d[i+2] = val;
  }
}

// Otsu ì´ì§„í™”
function otsuBinarize(imageData) {
  const d = imageData.data;
  const total = imageData.width * imageData.height;
  const hist = new Array(256).fill(0);
  for (let i = 0; i < d.length; i += 4) hist[Math.round(d[i])]++;
  let sum = 0;
  for (let i = 0; i < 256; i++) sum += i * hist[i];
  let sumB = 0, wB = 0, maxVar = 0, threshold = 128;
  for (let i = 0; i < 256; i++) {
    wB += hist[i];
    if (wB === 0) continue;
    const wF = total - wB;
    if (wF === 0) break;
    sumB += i * hist[i];
    const mB = sumB / wB, mF = (sum - sumB) / wF;
    const v = wB * wF * (mB - mF) * (mB - mF);
    if (v > maxVar) { maxVar = v; threshold = i; }
  }
  for (let i = 0; i < d.length; i += 4) {
    const val = d[i] > threshold ? 255 : 0;
    d[i] = d[i+1] = d[i+2] = val;
  }
}

// ì ì‘í˜• ì´ì§„í™” (ë¡œì»¬ ë¸”ë¡ ê¸°ë°˜ â€” Otsuë³´ë‹¤ ê¸°ìš¸ì–´ì§„ í…ìŠ¤íŠ¸ì— ê°•í•¨)
function adaptiveBinarize(imageData, blockSize = 15, C = 8) {
  const d = imageData.data;
  const w = imageData.width, h = imageData.height;
  const gray = new Uint8Array(w * h);
  for (let i = 0; i < gray.length; i++) gray[i] = d[i * 4];

  // ì ë¶„ ì´ë¯¸ì§€ (integral image)
  const integral = new Float64Array(w * h);
  for (let y = 0; y < h; y++) {
    let rowSum = 0;
    for (let x = 0; x < w; x++) {
      rowSum += gray[y * w + x];
      integral[y * w + x] = rowSum + (y > 0 ? integral[(y-1) * w + x] : 0);
    }
  }

  const half = Math.floor(blockSize / 2);
  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      const x1 = Math.max(0, x - half), y1 = Math.max(0, y - half);
      const x2 = Math.min(w - 1, x + half), y2 = Math.min(h - 1, y + half);
      const count = (x2 - x1 + 1) * (y2 - y1 + 1);
      let sum = integral[y2 * w + x2];
      if (x1 > 0) sum -= integral[y2 * w + (x1 - 1)];
      if (y1 > 0) sum -= integral[(y1 - 1) * w + x2];
      if (x1 > 0 && y1 > 0) sum += integral[(y1 - 1) * w + (x1 - 1)];
      const mean = sum / count;
      const val = gray[y * w + x] > (mean - C) ? 255 : 0;
      const idx = (y * w + x) * 4;
      d[idx] = d[idx+1] = d[idx+2] = val;
    }
  }
}

// ì´ë¯¸ì§€ë¥¼ íŠ¹ì • ê°ë„ë¡œ íšŒì „
function rotateCanvas(srcCanvas, angleDeg) {
  const rad = angleDeg * Math.PI / 180;
  const cos = Math.abs(Math.cos(rad)), sin = Math.abs(Math.sin(rad));
  const sw = srcCanvas.width, sh = srcCanvas.height;
  const nw = Math.ceil(sw * cos + sh * sin);
  const nh = Math.ceil(sw * sin + sh * cos);

  const rotCanvas = document.createElement('canvas');
  rotCanvas.width = nw;
  rotCanvas.height = nh;
  const rCtx = rotCanvas.getContext('2d');
  rCtx.fillStyle = '#ffffff';
  rCtx.fillRect(0, 0, nw, nh);
  rCtx.translate(nw / 2, nh / 2);
  rCtx.rotate(rad);
  rCtx.drawImage(srcCanvas, -sw / 2, -sh / 2);
  return rotCanvas;
}

// ê°„ì´ ê¸°ìš¸ê¸° ê°ì§€ â€” ì´ì§„í™” ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ í–‰ì˜ ê¸°ìš¸ê¸° ì¶”ì •
function detectSkewAngle(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const imgData = ctx.getImageData(0, 0, w, h);
  const d = imgData.data;

  // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ & ê°„ë‹¨í•œ ì´ì§„í™”
  const binary = new Uint8Array(w * h);
  for (let i = 0; i < binary.length; i++) {
    const g = 0.299 * d[i*4] + 0.587 * d[i*4+1] + 0.114 * d[i*4+2];
    binary[i] = g < 128 ? 1 : 0; // ì–´ë‘ìš´ í”½ì…€ = í…ìŠ¤íŠ¸
  }

  // Hough-like: ê° í–‰ì—ì„œ í…ìŠ¤íŠ¸ ì‹œì‘ì (ì™¼ìª½ ì²« ê²€ì • í”½ì…€) ìˆ˜ì§‘
  const rowStarts = [];
  const sampleStep = Math.max(1, Math.floor(h / 80)); // ìµœëŒ€ 80ì¤„ ìƒ˜í”Œë§
  for (let y = Math.floor(h * 0.1); y < Math.floor(h * 0.9); y += sampleStep) {
    for (let x = Math.floor(w * 0.05); x < Math.floor(w * 0.5); x++) {
      if (binary[y * w + x]) {
        rowStarts.push({ x, y });
        break;
      }
    }
  }

  if (rowStarts.length < 5) return 0; // ë°ì´í„° ë¶€ì¡±

  // ìµœì†ŒììŠ¹ë²•ìœ¼ë¡œ ê¸°ìš¸ê¸° ì¶”ì •
  let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
  const n = rowStarts.length;
  for (const p of rowStarts) {
    sumX += p.y; sumY += p.x; sumXY += p.y * p.x; sumXX += p.y * p.y;
  }
  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const angle = Math.atan(slope) * (180 / Math.PI);

  // í•©ë¦¬ì ì¸ ë²”ìœ„ë¡œ ì œí•œ (-20Â° ~ +20Â°)
  if (Math.abs(angle) > 20) return 0;
  return -angle; // ë³´ì •í•  ê°ë„ (ë°˜ëŒ€ ë°©í–¥)
}

// ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ë¥¼ ê·¸ë¦¬ê³  ì›í•˜ëŠ” ì „ì²˜ë¦¬ ì ìš©
function prepareCanvas(img, canvas, ctx, opts = {}) {
  const { upscale = 1, doSharpen = false, doBinarize = false, cropBottom = false,
          rotateDeg = 0, doDeskew = false, adaptiveBin = false } = opts;

  let srcCanvas = canvas;
  let srcCtx = ctx;

  // ì—…ìŠ¤ì¼€ì¼
  const maxW = 1600 * upscale;
  const scale = Math.min(maxW / img.width, upscale);
  srcCanvas.width = Math.round(img.width * scale);
  srcCanvas.height = Math.round(img.height * scale);
  srcCtx.drawImage(img, 0, 0, srcCanvas.width, srcCanvas.height);

  // í•˜ë‹¨ í¬ë¡­
  if (cropBottom) {
    const tmpCanvas = document.createElement('canvas');
    const tmpCtx = tmpCanvas.getContext('2d');
    const cropY = Math.floor(srcCanvas.height * 0.4);
    tmpCanvas.width = srcCanvas.width;
    tmpCanvas.height = srcCanvas.height - cropY;
    tmpCtx.drawImage(srcCanvas, 0, cropY, srcCanvas.width, tmpCanvas.height,
                     0, 0, tmpCanvas.width, tmpCanvas.height);
    srcCanvas.width = tmpCanvas.width;
    srcCanvas.height = tmpCanvas.height;
    srcCtx.drawImage(tmpCanvas, 0, 0);
  }

  // ìë™ ê¸°ìš¸ê¸° ë³´ì •
  if (doDeskew) {
    const skewAngle = detectSkewAngle(srcCanvas);
    if (Math.abs(skewAngle) > 0.5) {
      console.log(`[Deskew] ê°ì§€ ê°ë„: ${skewAngle.toFixed(1)}Â°`);
      const rotated = rotateCanvas(srcCanvas, skewAngle);
      srcCanvas.width = rotated.width;
      srcCanvas.height = rotated.height;
      srcCtx.drawImage(rotated, 0, 0);
    }
  }

  // ìˆ˜ë™ íšŒì „ (ë‹¤ì¤‘ ê°ë„ ì‹œë„ìš©)
  if (rotateDeg !== 0) {
    const rotated = rotateCanvas(srcCanvas, rotateDeg);
    srcCanvas.width = rotated.width;
    srcCanvas.height = rotated.height;
    srcCtx.drawImage(rotated, 0, 0);
  }

  // ìƒ¤í”„ë‹
  if (doSharpen) {
    sharpen(srcCanvas, srcCtx, 1.2);
  }

  // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ + ëŒ€ë¹„ + ì´ì§„í™”
  if (doBinarize) {
    const imageData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
    toGrayscale(imageData);
    enhanceContrast(imageData, 0.7);
    if (adaptiveBin) {
      adaptiveBinarize(imageData, 21, 10);
    } else {
      otsuBinarize(imageData);
    }
    srcCtx.putImageData(imageData, 0, 0);
  }

  return srcCanvas;
}

// ========== CN ì‹œë¦¬ì–¼ ì¶”ì¶œ í•¨ìˆ˜ ==========

// ê¸°ìš¸ì–´ì§„ ì´ë¯¸ì§€ì—ì„œ ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì ì˜¤ì¸ì‹ ë³´ì • ë§µ
const OCR_CHAR_FIX = {
  // ìˆ«ìâ†”ë¬¸ì í˜¼ë™
  '0': 'O', 'O': 'O', 'o': 'O',
  '1': '1', 'I': 'I', 'l': 'L', '|': 'I',
  '8': 'B', '5': 'S', '6': 'G', '2': 'Z',
  // ê¸°ìš¸ê¸°ë¡œ ì¸í•œ í˜¼ë™
  'U': 'V', 'V': 'V',
  '{': 'C', '[': 'C', '(': 'C',
  '}': 'J', ']': 'J', ')': 'J',
};

// CN ì‹œì‘ ë¶€ë¶„ì˜ ì˜¤ì¸ì‹ ë³´ì • (C, N ê°ê°)
const C_CANDIDATES = ['C', 'G', '(', '{', '[', '0', 'O', 'c'];
const N_CANDIDATES = ['N', 'M', 'H', 'W', 'n', 'N'];

function fixOcrChar(ch) {
  const c = ch.toUpperCase();
  // ì¼ë°˜ ë¬¸ìëŠ” ê·¸ëŒ€ë¡œ
  if (/[A-Z0-9]/.test(c)) return c;
  return OCR_CHAR_FIX[ch] || c;
}

// ì „ì²´ ë¬¸ìì—´ì—ì„œ ê° ê¸€ìë¥¼ ë³´ì •
function fixOcrString(str) {
  return str.split('').map(c => fixOcrChar(c)).join('');
}

function extractCNSerial(ocrText) {
  const rawText = ocrText.toUpperCase();
  console.log('[OCR ì›ë³¸]', ocrText);

  let foundSerial = null;

  // ===== 0ë‹¨ê³„: S/N, M/I ë¼ë²¨ ë’¤ì—ì„œ CN ì¶”ì¶œ (ê°€ì¥ ì •í™•) =====
  const lines = rawText.split('\n');
  for (const line of lines) {
    if (/S\s*\/?\s*N|M\s*\/?\s*I|SN\s*:|MI\s*:/i.test(line)) {
      const lineClean = line.replace(/[^A-Z0-9]/gi, '').toUpperCase();
      const stripped = lineClean.replace(/^.*?(CN)/, '$1');
      const m25 = stripped.match(/^CN[A-Z0-9]{23}/);
      if (m25) { foundSerial = m25[0]; break; }
      const m14 = stripped.match(/^CN[A-Z0-9]{12}/);
      if (m14) { foundSerial = m14[0]; break; }
      const m10 = stripped.match(/^CN[A-Z0-9]{8}/);
      if (m10) { foundSerial = m10[0]; break; }
      const f25 = lineClean.match(/CN[A-Z0-9]{23}/);
      if (f25) { foundSerial = f25[0]; break; }
      const f14 = lineClean.match(/CN[A-Z0-9]{12}/);
      if (f14) { foundSerial = f14[0]; break; }
      const f10 = lineClean.match(/CN[A-Z0-9]{8}/);
      if (f10) { foundSerial = f10[0]; break; }
    }
  }
  if (foundSerial) { console.log('[0ë‹¨ê³„-ë¼ë²¨]', foundSerial); return foundSerial; }

  // ===== 1ë‹¨ê³„: ë‹¨ì–´ ë‹¨ìœ„ CN ê²€ìƒ‰ =====
  const cleanText = rawText.replace(/[^A-Z0-9\n\s]/g, '');
  const words = cleanText.split(/\s+/);

  for (const w of words) {
    if (w.length === 25 && w.startsWith('CN')) { foundSerial = w; break; }
  }
  if (!foundSerial) {
    for (const w of words) {
      if (w.length === 14 && w.startsWith('CN')) { foundSerial = w; break; }
    }
  }
  if (!foundSerial) {
    for (const w of words) {
      if (w.length === 10 && w.startsWith('CN')) { foundSerial = w; break; }
    }
  }
  if (foundSerial) { console.log('[1ë‹¨ê³„-ë‹¨ì–´]', foundSerial); return foundSerial; }

  // ===== 2ë‹¨ê³„: ì „ì²´ í…ìŠ¤íŠ¸ ì—°ê²° í›„ CN ì •ê·œì‹ =====
  const allText = cleanText.replace(/\s+/g, '');
  const match25 = allText.match(/CN[A-Z0-9]{23}/);
  if (match25) { console.log('[2ë‹¨ê³„-ì—°ê²°25]', match25[0]); return match25[0]; }
  const match14 = allText.match(/CN[A-Z0-9]{12}/);
  if (match14) { console.log('[2ë‹¨ê³„-ì—°ê²°14]', match14[0]); return match14[0]; }
  const match10 = allText.match(/CN[A-Z0-9]{8}/);
  if (match10) { console.log('[2ë‹¨ê³„-ì—°ê²°10]', match10[0]); return match10[0]; }

  // ===== 3ë‹¨ê³„: ì¤„ ë‹¨ìœ„ CN ì¶”ì¶œ (íŠ¹ìˆ˜ë¬¸ì ì œê±°) =====
  for (const line of lines) {
    if (line.toUpperCase().includes('CN') || line.toUpperCase().includes('CM') || line.toUpperCase().includes('GN')) {
      const lineClean = fixOcrString(line.replace(/[^A-Z0-9]/gi, '').toUpperCase());
      const m25 = lineClean.match(/CN[A-Z0-9]{23}/);
      if (m25) { console.log('[3ë‹¨ê³„-ì¤„25]', m25[0]); return m25[0]; }
      const m14 = lineClean.match(/CN[A-Z0-9]{12}/);
      if (m14) { console.log('[3ë‹¨ê³„-ì¤„14]', m14[0]); return m14[0]; }
      const m10 = lineClean.match(/CN[A-Z0-9]{8}/);
      if (m10) { console.log('[3ë‹¨ê³„-ì¤„10]', m10[0]); return m10[0]; }
    }
  }

  // ===== 4ë‹¨ê³„: OCR ì˜¤ì¸ì‹ ë³´ì • í›„ ì¬ì‹œë„ =====
  const fixedAllText = fixOcrString(allText);
  const fm25 = fixedAllText.match(/CN[A-Z0-9]{23}/);
  if (fm25) { console.log('[4ë‹¨ê³„-ë³´ì •ì „ì²´25]', fm25[0]); return fm25[0]; }
  const fm14 = fixedAllText.match(/CN[A-Z0-9]{12}/);
  if (fm14) { console.log('[4ë‹¨ê³„-ë³´ì •ì „ì²´14]', fm14[0]); return fm14[0]; }
  const fm10 = fixedAllText.match(/CN[A-Z0-9]{8}/);
  if (fm10) { console.log('[4ë‹¨ê³„-ë³´ì •ì „ì²´10]', fm10[0]); return fm10[0]; }

  // ===== 5ë‹¨ê³„: CN-like íŒ¨í„´ (C/N ì˜¤ì¸ì‹) íƒì§€ =====
  // CNì˜ Cê°€ G,O,(,{,[ë¡œ, Nì´ M,H,Wë¡œ ì˜ëª» ì¸ì‹ëœ ê²½ìš°
  const cnLikePattern = /[CGO0({[\[][NMHWK]/g;
  let cnMatch;

  // ì›ë³¸ í…ìŠ¤íŠ¸ì—ì„œ
  const searchText = rawText.replace(/[^A-Z0-9CGO0({[\]NMHWK]/g, '');
  while ((cnMatch = cnLikePattern.exec(searchText)) !== null) {
    const pos = cnMatch.index;
    // 25ìë¦¬ ì‹œë„
    if (pos + 25 <= searchText.length) {
      const raw25 = searchText.slice(pos, pos + 25);
      const candidate = 'CN' + fixOcrString(raw25.slice(2));
      if (/^CN[A-Z0-9]{23}$/.test(candidate)) {
        console.log('[5ë‹¨ê³„-ë³´ì •25]', candidate, `(ì›ë³¸: ${raw25.slice(0,4)}...)`);
        return candidate;
      }
    }
    // 14ìë¦¬ ì‹œë„
    if (pos + 14 <= searchText.length) {
      const raw14 = searchText.slice(pos, pos + 14);
      const candidate = 'CN' + fixOcrString(raw14.slice(2));
      if (/^CN[A-Z0-9]{12}$/.test(candidate)) {
        console.log('[5ë‹¨ê³„-ë³´ì •14]', candidate, `(ì›ë³¸: ${raw14.slice(0,4)}...)`);
        return candidate;
      }
    }
    // 10ìë¦¬ ì‹œë„
    if (pos + 10 <= searchText.length) {
      const raw10 = searchText.slice(pos, pos + 10);
      const candidate = 'CN' + fixOcrString(raw10.slice(2));
      if (/^CN[A-Z0-9]{8}$/.test(candidate)) {
        console.log('[5ë‹¨ê³„-ë³´ì •10]', candidate, `(ì›ë³¸: ${raw10.slice(0,4)}...)`);
        return candidate;
      }
    }
  }

  // ===== 6ë‹¨ê³„: ì¤„ ë‹¨ìœ„ ë³´ì • ì¬ì‹œë„ (ê° ì¤„ì„ ë³´ì • í›„ CN ì¶”ì¶œ) =====
  for (const line of lines) {
    const rawLine = line.replace(/[^A-Z0-9]/gi, '').toUpperCase();
    if (rawLine.length < 8) continue;
    const fixedLine = fixOcrString(rawLine);
    const fl25 = fixedLine.match(/CN[A-Z0-9]{23}/);
    if (fl25) { console.log('[6ë‹¨ê³„-ì¤„ë³´ì •25]', fl25[0]); return fl25[0]; }
    const fl14 = fixedLine.match(/CN[A-Z0-9]{12}/);
    if (fl14) { console.log('[6ë‹¨ê³„-ì¤„ë³´ì •14]', fl14[0]); return fl14[0]; }
    const fl10 = fixedLine.match(/CN[A-Z0-9]{8}/);
    if (fl10) { console.log('[6ë‹¨ê³„-ì¤„ë³´ì •10]', fl10[0]); return fl10[0]; }
  }

  // ===== ì°¾ì§€ ëª»í•¨ =====
  console.log('[OCR] CN ì‹œë¦¬ì–¼ ì°¾ì§€ ëª»í•¨. ì „ì²´:', cleanText);
  return null;
}

// ========== ë°”ì½”ë“œ/QR ì½”ë“œ ê°ì§€ (ìµœìš°ì„ ) ==========

// ë°”ì½”ë“œ ë””ì½”ë”© í…ìŠ¤íŠ¸ì—ì„œ CN ì‹œë¦¬ì–¼ ì¶”ì¶œ
function extractCNFromBarcode(decoded) {
  const upper = decoded.toUpperCase().replace(/[\s\-]/g, '');
  console.log(`[ë°”ì½”ë“œ] ë””ì½”ë”© í…ìŠ¤íŠ¸: "${decoded}" â†’ ì •ë¦¬: "${upper}"`);

  // CNìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 25/14/10ìë¦¬ ì‹œë¦¬ì–¼ ì§ì ‘ ë§¤ì¹­
  const m25 = upper.match(/CN[A-Z0-9]{23}/);
  if (m25) { console.log(`[ë°”ì½”ë“œ] CN 25ìë¦¬ ì‹œë¦¬ì–¼ ë°œê²¬: ${m25[0]}`); return m25[0]; }
  const m14 = upper.match(/CN[A-Z0-9]{12}/);
  if (m14) { console.log(`[ë°”ì½”ë“œ] CN 14ìë¦¬ ì‹œë¦¬ì–¼ ë°œê²¬: ${m14[0]}`); return m14[0]; }
  const m10 = upper.match(/CN[A-Z0-9]{8}/);
  if (m10) { console.log(`[ë°”ì½”ë“œ] CN 10ìë¦¬ ì‹œë¦¬ì–¼ ë°œê²¬: ${m10[0]}`); return m10[0]; }

  // CNEë¡œ ì‹œì‘í•˜ëŠ” 25ìë¦¬ (E-PASS) â€” CNEê°€ í¬í•¨ëœ ê²½ìš°
  const mCNE = upper.match(/CNE[A-Z0-9]{22}/);
  if (mCNE) { console.log(`[ë°”ì½”ë“œ] CNE 25ìë¦¬ ì‹œë¦¬ì–¼ ë°œê²¬: ${mCNE[0]}`); return mCNE[0]; }

  // CNì´ í¬í•¨ë˜ì–´ ìˆì§€ë§Œ ì •í™•í•œ í¬ë§·ì´ ì•„ë‹Œ ê²½ìš°, ë³´ì • ì‹œë„
  if (upper.includes('CN')) {
    const fixed = fixOcrString(upper);
    const fm25 = fixed.match(/CN[A-Z0-9]{23}/);
    if (fm25) { console.log(`[ë°”ì½”ë“œ] CN 25ìë¦¬(ë³´ì •): ${fm25[0]}`); return fm25[0]; }
    const fm14 = fixed.match(/CN[A-Z0-9]{12}/);
    if (fm14) { console.log(`[ë°”ì½”ë“œ] CN 14ìë¦¬(ë³´ì •): ${fm14[0]}`); return fm14[0]; }
    const fm10 = fixed.match(/CN[A-Z0-9]{8}/);
    if (fm10) { console.log(`[ë°”ì½”ë“œ] CN 10ìë¦¬(ë³´ì •): ${fm10[0]}`); return fm10[0]; }
  }

  // ë°”ì½”ë“œ ë°ì´í„°ê°€ ì •í™•íˆ 10/14/25ìë¦¬ì´ê³  CNìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„)
  const cleaned = upper.replace(/[^A-Z0-9]/g, '');
  if (cleaned.startsWith('CN') && (cleaned.length === 10 || cleaned.length === 14 || cleaned.length === 25)) {
    console.log(`[ë°”ì½”ë“œ] ì •ë¦¬ í›„ CN ì‹œë¦¬ì–¼: ${cleaned}`);
    return cleaned;
  }

  console.log(`[ë°”ì½”ë“œ] ë°”ì½”ë“œ ì¸ì‹ëìœ¼ë‚˜ CN ì‹œë¦¬ì–¼ ì•„ë‹˜: ${decoded}`);
  return null;
}

// ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ë¡œ ë³€í™˜í•˜ì—¬ í¬ë¡­ëœ Blob ìƒì„±
function cropImageToBlob(img, x, y, w, h) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, x, y, w, h, 0, 0, w, h);
    canvas.toBlob((blob) => {
      resolve(blob ? new File([blob], 'crop.jpg', { type: 'image/jpeg' }) : null);
    }, 'image/jpeg', 0.95);
  });
}

async function tryBarcodeDetection(file) {
  try {
    console.log('[ë°”ì½”ë“œ] ë°”ì½”ë“œ/QR ì½”ë“œ ê°ì§€ ì‹œë„...');

    // 1ì°¨: ì›ë³¸ ì´ë¯¸ì§€ ì „ì²´ë¡œ ì‹œë„
    let serial = await scanBarcodeFromFile(file);
    if (serial) return serial;

    // 2ì°¨: ì´ë¯¸ì§€ë¥¼ ì—¬ëŸ¬ ì˜ì—­ìœ¼ë¡œ í¬ë¡­í•˜ì—¬ ì¬ì‹œë„ (ë°”ì½”ë“œê°€ ì´ë¯¸ì§€ ì¼ë¶€ì—ë§Œ ìˆëŠ” ê²½ìš°)
    console.log('[ë°”ì½”ë“œ] ì „ì²´ ì´ë¯¸ì§€ ì‹¤íŒ¨ â†’ ì˜ì—­ í¬ë¡­ ì¬ì‹œë„...');
    const img = await loadImage(file);
    const iw = img.width, ih = img.height;

    // ë°”ì½”ë“œê°€ ì£¼ë¡œ ìœ„ì¹˜í•˜ëŠ” ì˜ì—­ë“¤ (ì¢Œìƒ, ì¢Œì¸¡, ìƒë‹¨, ì¤‘ì•™)
    const cropRegions = [
      { name: 'ì¢Œìƒë‹¨', x: 0, y: 0, w: Math.round(iw * 0.5), h: Math.round(ih * 0.5) },
      { name: 'ì¢Œì¸¡', x: 0, y: 0, w: Math.round(iw * 0.4), h: ih },
      { name: 'ìƒë‹¨', x: 0, y: 0, w: iw, h: Math.round(ih * 0.4) },
      { name: 'í•˜ë‹¨', x: 0, y: Math.round(ih * 0.3), w: iw, h: Math.round(ih * 0.7) },
      { name: 'ì¤‘ì•™', x: Math.round(iw * 0.1), y: Math.round(ih * 0.1), w: Math.round(iw * 0.8), h: Math.round(ih * 0.8) },
    ];

    for (const region of cropRegions) {
      try {
        const cropFile = await cropImageToBlob(img, region.x, region.y, region.w, region.h);
        if (!cropFile) continue;
        serial = await scanBarcodeFromFile(cropFile);
        if (serial) {
          console.log(`[ë°”ì½”ë“œ] í¬ë¡­ ì˜ì—­ "${region.name}"ì—ì„œ ì¸ì‹ ì„±ê³µ: ${serial}`);
          return serial;
        }
      } catch (e) {
        // í¬ë¡­ ì‹œë„ ì‹¤íŒ¨ â€” ë‹¤ìŒ ì˜ì—­ìœ¼ë¡œ
      }
    }

    // 3ì°¨: ì´ë¯¸ì§€ ìŠ¤ì¼€ì¼ ì—… í›„ ì¬ì‹œë„ (ì‘ì€ ë°”ì½”ë“œì¸ ê²½ìš°)
    console.log('[ë°”ì½”ë“œ] í¬ë¡­ ì‹¤íŒ¨ â†’ ìŠ¤ì¼€ì¼ì—… ì¬ì‹œë„...');
    try {
      const scaleCanvas = document.createElement('canvas');
      const scale = Math.min(2, 2000 / Math.max(iw, ih));
      if (scale > 1.2) {
        scaleCanvas.width = Math.round(iw * scale);
        scaleCanvas.height = Math.round(ih * scale);
        const sCtx = scaleCanvas.getContext('2d');
        sCtx.drawImage(img, 0, 0, scaleCanvas.width, scaleCanvas.height);
        const scaleBlob = await new Promise(r => scaleCanvas.toBlob(r, 'image/jpeg', 0.95));
        if (scaleBlob) {
          const scaleFile = new File([scaleBlob], 'scaled.jpg', { type: 'image/jpeg' });
          serial = await scanBarcodeFromFile(scaleFile);
          if (serial) {
            console.log(`[ë°”ì½”ë“œ] ìŠ¤ì¼€ì¼ì—…(${scale.toFixed(1)}x)ì—ì„œ ì¸ì‹ ì„±ê³µ: ${serial}`);
            return serial;
          }
        }
      }
    } catch (e) {
      console.log('[ë°”ì½”ë“œ] ìŠ¤ì¼€ì¼ì—… ì‹œë„ ì‹¤íŒ¨:', e.message);
    }

    console.log('[ë°”ì½”ë“œ] ëª¨ë“  ë°”ì½”ë“œ ê°ì§€ ì‹œë„ ì‹¤íŒ¨');
    return null;
  } catch (err) {
    console.log('[ë°”ì½”ë“œ] ë°”ì½”ë“œ ê°ì§€ ì˜¤ë¥˜:', err.message);
    return null;
  }
}

// ë‹¨ì¼ íŒŒì¼ì—ì„œ ë°”ì½”ë“œ ìŠ¤ìº”
async function scanBarcodeFromFile(file) {
  try {
    const html5Qrcode = new Html5Qrcode("barcodeReader", { verbose: false });
    const result = await html5Qrcode.scanFileV2(file, /* showImage= */ false);
    const decoded = result.decodedText;
    const format = result.result && result.result.format ? result.result.format.formatName : 'unknown';
    console.log(`[ë°”ì½”ë“œ] ê°ì§€ ì„±ê³µ (${format}): ${decoded}`);
    html5Qrcode.clear();
    return extractCNFromBarcode(decoded);
  } catch (err) {
    return null;
  }
}

// ê³µí†µ OCR ì²˜ë¦¬ í•¨ìˆ˜ â€” ê°•í™”ëœ ë‹¤ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ (ê¸°ìš¸ê¸° ë³´ì • í¬í•¨)
async function processImageFile(file) {
  const status = document.getElementById('ocrStatus');
  status.textContent = 'ğŸ“· ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...';

  // ì´ˆê¸°í™”
  lastBarcodeSerial = null;
  lastOcrSerial = null;

  try {
    // ===== 1ë‹¨ê³„: ë°”ì½”ë“œ/QR ì½”ë“œ ê°ì§€ ì‹œë„ (ìµœìš°ì„ ) =====
    status.textContent = 'ğŸ” ë°”ì½”ë“œ/QR ì½”ë“œ ê°ì§€ ì¤‘...';
    const barcodeSerial = await tryBarcodeDetection(file);
    if (barcodeSerial) {
      lastBarcodeSerial = barcodeSerial;
      console.log(`[ë°”ì½”ë“œ] ê²°ê³¼ ì €ì¥: ${barcodeSerial}`);
    }

    // ===== 2ë‹¨ê³„: OCR íŒŒì´í”„ë¼ì¸ (ë°”ì½”ë“œ ì„±ê³µ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì‹¤í–‰ â€” ì´ë¯¸ì§€ í”„ë¦¬ë·°ìš©) =====
    status.textContent = barcodeSerial
      ? `âœ… ë°”ì½”ë“œ ì¸ì‹: ${barcodeSerial} â€” ë¬¸ì ì¸ì‹ë„ ì§„í–‰ ì¤‘...`
      : 'ğŸ” í…ìŠ¤íŠ¸ ì¸ì‹ ì¤€ë¹„ ì¤‘...';

    const img = await loadImage(file);
    const canvas = document.getElementById('ocrCanvas');
    const ctx = canvas.getContext('2d');

    // 1ì°¨: ê¸°ë³¸ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
    const basicAttempts = [
      { name: 'ì›ë³¸',                opts: { upscale: 1, doSharpen: false, doBinarize: false } },
      { name: 'ìƒ¤í”„ë‹',              opts: { upscale: 1, doSharpen: true,  doBinarize: false } },
      { name: '2ë°°+ìƒ¤í”„ë‹',          opts: { upscale: 2, doSharpen: true,  doBinarize: false } },
      { name: 'ìë™ê¸°ìš¸ê¸°ë³´ì •+ìƒ¤í”„ë‹', opts: { upscale: 2, doSharpen: true,  doBinarize: false, doDeskew: true } },
      { name: 'ì´ì§„í™”(Otsu)',        opts: { upscale: 2, doSharpen: true,  doBinarize: true } },
      { name: 'ì ì‘í˜•ì´ì§„í™”',         opts: { upscale: 2, doSharpen: true,  doBinarize: true,  adaptiveBin: true } },
      { name: 'ìë™ê¸°ìš¸ê¸°+ì´ì§„í™”',    opts: { upscale: 2, doSharpen: true,  doBinarize: true,  doDeskew: true } },
      { name: 'í•˜ë‹¨í¬ë¡­+ìƒ¤í”„ë‹',     opts: { upscale: 2, doSharpen: true,  doBinarize: false, cropBottom: true } },
    ];

    // 2ì°¨: ìˆ˜ë™ íšŒì „ ì‹œë„ (ê¸°ìš¸ê¸°ê°€ ì‹¬í•œ ê²½ìš°)
    const rotationAngles = [-10, -7, -5, -3, 3, 5, 7, 10];
    const rotationAttempts = rotationAngles.map(deg => ({
      name: `íšŒì „ ${deg > 0 ? '+' : ''}${deg}Â°+ìƒ¤í”„ë‹`,
      opts: { upscale: 2, doSharpen: true, doBinarize: false, rotateDeg: deg }
    }));

    const allAttempts = [...basicAttempts, ...rotationAttempts];
    const totalSteps = allAttempts.length;

    // ë°”ì½”ë“œê°€ ì´ë¯¸ ì„±ê³µí•œ ê²½ìš° OCRì€ ì´ë¯¸ì§€ í”„ë¦¬ë·°ìš©ìœ¼ë¡œ ê¸°ë³¸ ì‹œë„ë§Œ
    const ocrAttempts = barcodeSerial ? basicAttempts.slice(0, 3) : allAttempts;
    const ocrTotalSteps = ocrAttempts.length;

    let foundSerial = null;
    let attemptNum = 0;

    for (const attempt of ocrAttempts) {
      attemptNum++;
      const label = `[${attemptNum}/${ocrTotalSteps}] ${attempt.name}`;
      console.log(`[OCR ì‹œë„] ${label}`);

      if (attemptNum <= basicAttempts.length) {
        status.textContent = barcodeSerial
          ? `âœ… ë°”ì½”ë“œ: ${barcodeSerial} â€” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...`
          : (attemptNum === 1
            ? 'ğŸ” í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘... (ìµœì´ˆ ë¡œë”© ì‹œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)'
            : `ğŸ” ${attempt.name} ë¶„ì„ ì¤‘... (${attemptNum}/${basicAttempts.length})`);
      } else {
        status.textContent = `ğŸ”„ ê¸°ìš¸ê¸° ë³´ì • ì‹œë„ ì¤‘... (${attempt.name})`;
      }

      prepareCanvas(img, canvas, ctx, attempt.opts);

      const ocrOpts = attemptNum === 1 ? {
        logger: m => {
          if (m.status === 'recognizing text') {
            const pct = Math.round((m.progress || 0) * 100);
            status.textContent = `ğŸ” í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘... ${pct}%`;
          }
        }
      } : {};

      const { data } = await Tesseract.recognize(canvas, 'eng', ocrOpts);
      foundSerial = extractCNSerial(data.text);

      if (foundSerial) {
        console.log(`[OCR ì„±ê³µ] ${label} â†’ ${foundSerial}`);
        lastOcrData = data; // ë°”ìš´ë”©ë°•ìŠ¤ ì •ë³´ ì €ì¥
        lastOcrCanvas = canvas;
        break;
      }

      // ê¸°ë³¸ íŒŒì´í”„ë¼ì¸ ëª¨ë‘ ì‹¤íŒ¨ í›„ íšŒì „ ì‹œë„ ì „ ì•ˆë‚´
      if (attemptNum === basicAttempts.length && !foundSerial) {
        console.log('[OCR] ê¸°ë³¸ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨, íšŒì „ ë³´ì • ì‹œì‘...');
      }
    }

    // ===== ê²°ê³¼ ì²˜ë¦¬ =====
    // OCR ê²°ê³¼ ì €ì¥
    if (foundSerial) {
      lastOcrSerial = foundSerial;
      lastOcrImageDataUrl = buildCroppedSerialPreview(canvas, lastOcrData, foundSerial);
    } else {
      lastOcrSerial = null;
      lastOcrImageDataUrl = null;
    }

    // ìµœì¢… ì‹œë¦¬ì–¼ ê²°ì •: ë°”ì½”ë“œ ìš°ì„ , ì—†ìœ¼ë©´ OCR
    const finalSerial = lastBarcodeSerial || foundSerial;

    if (finalSerial) {
      // ë°”ì½”ë“œ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‹œë¦¬ì–¼ë¡œ ì´ë¯¸ì§€ í”„ë¦¬ë·° ì¬ìƒì„±
      if (lastBarcodeSerial && lastOcrData && lastBarcodeSerial !== foundSerial) {
        lastOcrImageDataUrl = buildCroppedSerialPreview(canvas, lastOcrData, lastBarcodeSerial);
      }

      document.getElementById('serialInput').value = finalSerial;
      if (lastBarcodeSerial) {
        status.textContent = `âœ… ë°”ì½”ë“œ ì¸ì‹ ì™„ë£Œ: ${finalSerial}` + (foundSerial && foundSerial !== lastBarcodeSerial ? ` (ë¬¸ì: ${foundSerial})` : '');
      } else {
        status.textContent = `âœ… ì¸ì‹ ì™„ë£Œ: ${finalSerial}`;
      }
      const result = parseSerial(finalSerial);
      // ë°”ì½”ë“œ ê²°ê³¼ ì‚¬ìš© ì‹œì—ëŠ” ì •í™•í•˜ë¯€ë¡œ isFromOCR=false (ì• ë§¤í•œ ë¬¸ì ì„ íƒ ë¶ˆí•„ìš”)
      // í•˜ì§€ë§Œ ì´ë¯¸ì§€ í”„ë¦¬ë·°ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ isFromOCR=true ìœ ì§€ (ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´)
      const isOcrMode = !lastBarcodeSerial;
      showResult(result, isOcrMode);
    } else {
      lastOcrImageDataUrl = null;
      status.textContent = 'âš ï¸ CN ì‹œë¦¬ì–¼ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    }
  } catch (err) {
    status.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + err.message;
    console.error('[OCR ì—ëŸ¬]', err);
  }
}

document.getElementById('cameraInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  await processImageFile(file);
  e.target.value = '';
});

document.getElementById('galleryInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  await processImageFile(file);
  e.target.value = '';
});

function loadImage(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

// ========== íˆìŠ¤í† ë¦¬ ==========
function addHistory(serial, dateStr) {
  let history = JSON.parse(localStorage.getItem('serialHistory') || '[]');
  // ì¤‘ë³µ ì œê±°
  history = history.filter(h => h.serial !== serial);
  history.unshift({ serial, dateStr, time: new Date().toLocaleString('ko-KR') });
  history = history.slice(0, 10); // ìµœëŒ€ 10ê°œ
  localStorage.setItem('serialHistory', JSON.stringify(history));
  renderHistory();
}

function loadHistory() {
  renderHistory();
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem('serialHistory') || '[]');
  const list = document.getElementById('historyList');
  const section = document.getElementById('historySection');

  if (history.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  list.innerHTML = history.map(h => `
    <div class="history-item" onclick="recheck('${h.serial}')">
      <span class="h-serial">${h.serial}</span>
      <span class="h-date">${h.dateStr}</span>
    </div>
  `).join('');
}

function recheck(serial) {
  document.getElementById('serialInput').value = serial;
  const result = parseSerial(serial);
  showResult(result, false); // íˆìŠ¤í† ë¦¬ ì¬ì¡°íšŒ â€” í›„ë³´ ì„ íƒ ë¶ˆí•„ìš”
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ========== PWA Service Worker ë“±ë¡ ==========
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('[SW] ë“±ë¡ ì™„ë£Œ:', reg.scope);
        // ìƒˆ SWê°€ ì„¤ì¹˜ë  ë•Œ ìºì‹± ì™„ë£Œ í‘œì‹œ
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'activated') {
              showCacheToast('âœ… ì˜¤í”„ë¼ì¸ ìºì‹± ì™„ë£Œ! ì´ì œ ì–´ë””ì„œë“  ì‚¬ìš© ê°€ëŠ¥');
            }
          });
        });
        // ì´ë¯¸ í™œì„±í™”ëœ ê²½ìš°
        if (reg.active) {
          console.log('[SW] ì´ë¯¸ í™œì„±í™”ë¨ â€” ìºì‹œ ì‚¬ìš© ê°€ëŠ¥');
        }
      })
      .catch(err => console.warn('[SW] ë“±ë¡ ì‹¤íŒ¨:', err));
  });
}

function showCacheToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  Object.assign(toast.style, {
    position: 'fixed', top: '60px', left: '50%', transform: 'translateX(-50%)',
    background: '#059669', color: '#fff', padding: '10px 20px', borderRadius: '8px',
    fontSize: '13px', fontWeight: '600', zIndex: '10001', textAlign: 'center',
    boxShadow: '0 2px 12px rgba(0,0,0,0.2)', animation: 'slideDown 0.3s ease',
    whiteSpace: 'nowrap'
  });
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; }, 3000);
  setTimeout(() => toast.remove(), 3500);
}

// ========== PWA ì„¤ì¹˜ ì•ˆë‚´ (iOS + Android) ==========
let deferredInstallPrompt = null;

// Android Chrome: beforeinstallprompt ì´ë²¤íŠ¸ ìº¡ì²˜
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  showInstallBanner('android');
});

// ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ê°ì§€
window.addEventListener('appinstalled', () => {
  deferredInstallPrompt = null;
  showCacheToast('âœ… ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
});

function showInstallBanner(platform) {
  const dismissed = sessionStorage.getItem('pwa-banner-dismissed');
  if (dismissed) return;

  // ì´ë¯¸ standaloneìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì´ë©´ í‘œì‹œ ì•ˆ í•¨
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;

  setTimeout(() => {
    const banner = document.createElement('div');
    banner.id = 'pwaBanner';

    if (platform === 'android') {
      banner.innerHTML = `
        <div style="
          position:fixed; bottom:0; left:0; right:0; z-index:10000;
          background:#fff; border-top:2px solid #0096D6;
          padding:16px 20px; padding-bottom:16px;
          box-shadow:0 -2px 12px rgba(0,0,0,0.12);
          display:flex; align-items:center; gap:12px;
          font-family:-apple-system,sans-serif;
          animation: slideUp 0.3s ease;
        ">
          <img src="icon-192.png" style="width:48px;height:48px;border-radius:12px;" alt="ì•± ì•„ì´ì½˜">
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;color:#1a1a2e;">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>
            <div style="font-size:12px;color:#6b7280;margin-top:2px;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ì•±ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥</div>
          </div>
          <button id="pwaInstallBtn" style="
            background:#0096D6;color:#fff;border:none;border-radius:8px;
            padding:10px 16px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;
          ">ì„¤ì¹˜</button>
          <button onclick="document.getElementById('pwaBanner').remove();sessionStorage.setItem('pwa-banner-dismissed','1');" 
                  style="background:none;border:none;font-size:18px;color:#9ca3af;padding:4px;cursor:pointer;">âœ•</button>
        </div>
      `;
      document.body.appendChild(banner);
      document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
        if (deferredInstallPrompt) {
          deferredInstallPrompt.prompt();
          const result = await deferredInstallPrompt.userChoice;
          if (result.outcome === 'accepted') {
            banner.remove();
          }
          deferredInstallPrompt = null;
        }
      });
    } else {
      // iOS Safari
      banner.innerHTML = `
        <div style="
          position:fixed; bottom:0; left:0; right:0; z:10000;
          background:#fff; border-top:2px solid #0096D6;
          padding:16px 20px; padding-bottom:calc(env(safe-area-inset-bottom,16px) + 8px);
          box-shadow:0 -2px 12px rgba(0,0,0,0.12);
          display:flex; align-items:center; gap:12px;
          font-family:-apple-system,sans-serif;
          animation: slideUp 0.3s ease;
          z-index:10000;
        ">
          <img src="icon-192.png" style="width:48px;height:48px;border-radius:12px;" alt="ì•± ì•„ì´ì½˜">
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;color:#1a1a2e;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</div>
            <div style="font-size:12px;color:#6b7280;margin-top:2px;">
              <span style="vertical-align:middle;">Safari í•˜ë‹¨</span>
              <span style="font-size:18px;vertical-align:middle;">â¬†ï¸</span>
              <span style="vertical-align:middle;">â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"</span>
            </div>
          </div>
          <button onclick="document.getElementById('pwaBanner').remove();sessionStorage.setItem('pwa-banner-dismissed','1');" 
                  style="background:none;border:none;font-size:20px;color:#9ca3af;padding:8px;cursor:pointer;">âœ•</button>
        </div>
      `;
      document.body.appendChild(banner);
    }
  }, 2000);
}

// iOS ê°ì§€ â€” beforeinstallpromptê°€ ì•ˆ ëœ¨ëŠ” ê²½ìš°
(function() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone === true;
  if (isIOS && !isStandalone) {
    showInstallBanner('ios');
  }
})();
</script>

<style>
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  @keyframes slideDown {
    from { transform: translate(-50%, -20px); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
  }
</style>

</body>
</html>
